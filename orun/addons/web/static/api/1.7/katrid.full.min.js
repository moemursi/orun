var Katrid={Core:{}};!function(){_.emptyText="--";class e{static init(){Katrid.localSettings=new e}constructor(){}get searchMenuVisible(){return 1===parseInt(localStorage.searchMenuVisible)}set searchMenuVisible(e){localStorage.searchMenuVisible=e?1:0}}const t=(a=!1,i=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(i)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(i.substr(0,4)))&&(a=!0),a);var i,a;Katrid.settings={additionalModules:[],server:"",servicesProtocol:"undefined"!=typeof io&&null!==io&&io.connect?"io":"http",ui:{isMobile:t,dateInputMask:!0,defaultView:"list",goToDefaultViewAfterCancelInsert:!0,goToDefaultViewAfterCancelEdit:!1,horizontalForms:!0},services:{choicesPageLimit:10},speech:{enabled:!1}},Katrid.Core.LocalSettings=e,"io"===Katrid.settings.servicesProtocol&&(Katrid.socketio=io.connect(`//${document.domain}:${location.port}/rpc`))}(),function(){Katrid.Core.Application=class{constructor(e){Katrid.app=this,this.actionManager=new Katrid.Actions.ActionManager,this.title=e.title,this.plugins=["ui.router","ui.katrid","ngSanitize"],$.get("/web/client/templates/").then(e=>{this.ngApp=angular.module("katridApp",this.plugins).run(["$templateCache",t=>{this.$templateCache=t,new Katrid.ui.Templates(this,e)}]).config(["$locationProvider",function(e){e.hashPrefix("")}]).config(["$stateProvider",e=>{e.state("menuEntry",{url:"/menu/:menuId/",controller:"MenuController",reloadOnSearch:!1}).state("actionView",{url:"/action/:actionId/?view_type&id",reloadOnSearch:!1,controller:"ActionController",resolve:{action:["$stateParams","$state","$location",async(e,t,i)=>{let a=e;Katrid.app.actionManager.clear();let s=await Katrid.Services.Actions.load(a.actionId),r=new Katrid.Services.Model(s.model),n=new Katrid.Actions[s.action_type](s,null,i);return n.model=r,t.$current.data={action:n},await n.execute(),n}]},templateProvider:["$stateParams","$state",async(e,t)=>{let i=t.$current.data.action;if("ir.action.window"===i.info.action_type){let e=t.$current.data.action.views;return e&&Object.keys(e).map(t=>e[t].type=t),this.getTemplate(i.templateUrl,{views:t.$current.data.action.views})}return this.getTemplate(i.templateUrl)}]})}]),this._initControllers(),angular.element(function(){angular.bootstrap(document,["katridApp"]),$(Katrid).trigger("app.ready",[this])})})}getTemplate(e,t){let i=this.$templateCache.get(e);return e.endsWith("pug")&&(i=i(t)),i}static get context(){return this.actionManager.context}_initControllers(){this.ngApp.controller("MenuController",["$scope","$stateParams",function(e,t){setTimeout(()=>{let i=t.menuId,a=$(`#left-side-menu[data-menu-id='${i}']`).find(".menu-item-action").first();e.$parent.current_menu=parseInt(i),a.click()},0)}]),this.ngApp.controller("ActionController",["$scope","$compile","$state","action","$element","$location","$transitions",function(e,t,i,a,s,r,n){Katrid.Core.compile=t,a.$state=i,a.scope=e,a.$element=s,e.action=a,e.model=a.model,e.Katrid=Katrid,e._=_,e.data=null,e.record=null,Object.defineProperty(e,"self",{get:()=>e.record}),e.recordIndex=null,e.recordId=null,e.records=null,e.recordCount=0,e.dataSource=new Katrid.Data.DataSource(e),e.$setDirty=(t=>{const i=e.form[t];i&&i.$setDirty()}),n.onBefore({to:"actionView"},function(e,t){i.params.actionId!==e.params().actionId&&a._unregisterHook()}),a instanceof Katrid.Actions.WindowAction&&(a.viewType=r.$$search.view_type||a.viewModes[0]),a._unregisterHook=e.$on("$locationChangeSuccess",()=>{a.routeUpdate(r.$$search)}),a.routeUpdate(r.$$search)}])}}}(),function(){Katrid.$hashId=0,_.mixin({hash:e=>(e.$hashId||(e.$hashId=++Katrid.$hashId),e.$hashId)})}.call(this),function(){const e=this;Katrid.i18n={languageCode:"pt-BR",formats:{},catalog:{},initialize:(t,i,a)=>(Katrid.i18n.plural=t,Katrid.i18n.catalog=i,Katrid.i18n.formats=a,Katrid.i18n.pluralidx=t?function(e){return t instanceof boolean?t?1:0:t}:function(e){return 1===count?0:1},e.pluralidx=Katrid.i18n.pluralidx,e.gettext=Katrid.i18n.gettext,e.ngettext=Katrid.i18n.ngettext,e.gettext_noop=Katrid.i18n.gettext_noop,e.pgettext=Katrid.i18n.pgettext,e.npgettext=Katrid.i18n.npgettext,e.interpolate=Katrid.i18n.interpolate,e.get_format=Katrid.i18n.get_format,_.mixin({gettext:Katrid.i18n.gettext,sprintf:sprintf}),Katrid.i18n.initialized=!0),merge:e=>Array.from(e).map(t=>Katrid.i18n.catalog[t]=e[t]),gettext(e){const t=Katrid.i18n.catalog[e];return null!=t?t:e},gettext_noop:e=>e,ngettext(e,t,i){const a=Katrid.i18n.catalog[e];return null!=a?a[Katrid.i18n.pluralidx(i)]:1===i?e:t},pgettext(e){let t=Katrid.i18n.gettext(e);return-1!==t.indexOf("")&&(t=e),t},npgettext(e,t,i,a){let s=Katrid.i18n.ngettext(e+""+t,e+""+i,a);return-1!==s.indexOf("")&&(s=Katrid.i18n.ngettext(t,i,a)),s},interpolate:(e,t,i)=>(i?e.replace(/%\(\w+\)s/g,e=>String(t[e.slice(2,-2)])):e.replace(/%s/g,e=>String(t.shift())),{get_format(e){const t=Katrid.i18n.formats[e];return null!=t?t:e}})}}(),function(){let e;Katrid.socketio&&(e=new class{constructor(){this.requestId=0,this.requests={}}request(){const t=++e.requestId,i=new $.Deferred;return this.requests[t]=i,i.requestId=t,i}},Katrid.socketio.on("connect",()=>console.log("I'm connected!")),Katrid.socketio.on("api",function(t){return _.isString(t)&&(t=JSON.parse(t)),e.requests[t["req-id"]].resolve(t)}));class t{static get url(){return"/api/rpc/"}constructor(e,t){this.name=e}static $fetch(e,t,i){return i&&(e=new URL(e),Object.entries(i).map((t,i)=>e.searchParams.append(t,i))),fetch(e,t)}static $post(e,t,i){return this.$fetch(e,{method:"POST",credentials:"same-origin",body:JSON.stringify(t),headers:{"content-type":"application/json"}},i).then(e=>e.json())}delete(e,t,i){}get(e,t){if("ws"===Katrid.Settings.servicesProtocol)return Katrid.socketio.emit("api",{channel:"rpc",service:this.name,method:e,data:data,args:t});{const i=this.name?this.name+"/":"",a=Katrid.Settings.server+this.constructor.url+i+e+"/";return $.get(a,t)}}post(t,i,a){let s=Katrid.app.context;if(i||(i={}),s&&(i.context=s),i={jsonrpc:"2.0",method:t,params:i,id:Math.floor(1e3*Math.random()*1e3*1e3)},"io"===Katrid.settings.servicesProtocol){const s=e.request();return Katrid.socketio.emit("api",{"req-id":s.requestId,"req-method":"POST",service:this.name,method:t,data:i,args:a}),s}{const e=this.name?this.name+"/":"";let s=Katrid.settings.server+this.constructor.url+e+t+"/";return a&&(s+=`?${$.param(a)}`),new Promise((e,t)=>{$.ajax({method:"POST",url:s,data:JSON.stringify(i),contentType:"application/json; charset=utf-8",dataType:"json"}).then(i=>{i.error?t(i.error):e(i.result)}).fail(e=>t(e))})}}}class i extends t{searchName(e){return _.isString(e)&&(e={args:e}),this.post("search_name",e)}createName(e){let t={name:e};return this.post("create_name",{kwargs:t})}search(e,t){return this.post("search",{kwargs:e},t)}destroy(e){return _.isArray(e)||(e=[e]),this.post("destroy",{kwargs:{ids:e}})}getById(e){return this.post("get",{args:[e]})}getDefaults(){return this.post("get_defaults",{})}copy(e){return this.post("copy",{args:[e]})}static _prepareFields(e){return e&&(e.fields=Katrid.Data.Fields.Field.fromArray(e.fields),e.fieldList=Object.values(e.fields),e.views&&(Object.values(e.views).map(e=>e.fields=Katrid.Data.Fields.Field.fromArray(e.fields)),Object.keys(e.views).map(t=>e.views[t]=new Katrid.ui.ViewInfo(e.views[t])))),e}getViewInfo(e){return this.post("get_view_info",{kwargs:e}).then(this.constructor._prepareFields)}async loadViews(e){return this.post("load_views",{kwargs:e}).then(this.constructor._prepareFields)}getFieldsInfo(e){return this.post("get_fields_info",{kwargs:e}).then(this.constructor._prepareFields)}getFieldChoices(e,t,i){return this.post("get_field_choices",{args:[e,t],kwargs:i})}doViewAction(e){return this.post("do_view_action",{kwargs:e})}write(e,t){return new Promise((i,a)=>{this.post("write",{kwargs:{data:e}},t).then(e=>{Katrid.ui.Dialogs.Alerts.success(Katrid.i18n.gettext("Record saved successfully.")),i(e)}).catch(e=>{500===e.status&&e.responseText?alert(e.responseText):Katrid.ui.Dialogs.Alerts.error(Katrid.i18n.gettext("Error saving record changes")),a(e)})})}groupBy(e){return this.post("group_by",{kwargs:e})}autoReport(){return this.post("auto_report",{kwargs:{}})}rpc(e,t,i){return this.post(e,{args:t,kwargs:i})}}class a extends i{constructor(){super("ir.query")}static read(e){return(new a).post("read",{args:[e]})}}class s extends t{static get url(){return"/web/data/"}reorder(e,t,i="sequence",a=0){return this.post("reorder",{args:[e,t,i,a]})}}this.Katrid.Services={Data:s,View:class extends i{constructor(){super("ui.view")}fromModel(e){return this.post("from_model",null,{model:e})}},data:new s(""),Attachments:class{static destroy(e){new i("ir.attachment").destroy(e)}static upload(e,t=null){let i=new FormData;null===t&&(t=angular.element(e).scope()),i.append("model",t.model.name),i.append("id",t.recordId);for(let t of e.files)i.append("attachment",t,t.name);return $.ajax({url:"/web/content/upload/",type:"POST",data:i,processData:!1,contentType:!1}).done(e=>{if(console.log("attachments",t.attachments,t),t.attachments||(t.attachments=[]),e)for(let i of e)t.attachments.push(i);t.$apply()})}},Service:t,Model:i,Query:a,Auth:class extends t{static login(e,t){return this.$post("/web/login/",{username:e,password:t})}},Upload:class{static sendFile(e,t){let i=new FormData;i.append("files",t.files[0]);let a=angular.element(t).scope();$.ajax({url:`/web/file/upload/${a.model.name}/${e}/?id=${a.record.id}`,data:i,processData:!1,contentType:!1,type:"POST",success:e=>{console.log("success",e),a.dataSource.refresh(),Katrid.ui.Dialogs.Alerts.success("Operação realizada com sucesso.")}})}},Actions:class extends i{static load(e){return new i("ir.action").post("load",{args:[e]})}}}}(),Katrid.Data={},function(){class e{constructor(e,t,i){this.raw=e,this.data={},this.old=jQuery.extend({},e),this.dataSource=t,this.pending=null,this.modified=!1,this.children=[],this.state=i,this.submitted=!1,e.$record=this}get scope(){return this.dataSource.scope}get pk(){return this.raw.id}$delete(){this.state=t.destroyed,this.pk?this.setModified():this.parent.children.indexOf(this)>-1&&this.parent.children.splice(this.parent.children.indexOf(this),1)}_prepareRecord(e){let t={};return Object.entries(e).map(e=>{e[0].startsWith("$")||(t[e[0]]=e[1])}),t}setModified(e){this.modified||this.state===t.destroyed||(this.pk?this.state=t.modified:this.state=t.created),e&&this.dataSource.$setDirty(e),this.dataSource._pendingChanges=!0,this.modified=!0,this.parent&&this.scope.fieldName&&(this.parent.setModified(this.scope.fieldName),this.parent.addChild(this))}get parent(){return this.dataSource.parent&&this.dataSource.parent.record.$record}addChild(e){this.setModified(e.scope.fieldName),-1===this.children.indexOf(e)&&this.children.push(e)}compare(e,t){return _.isArray(e)&&_.isArray(t)?e.join(",")!==t.join(","):e!=t}set(e,t){let i=this.dataSource.fieldByName(e);if(i){let a=this.raw[e];if(t=i.toJSON(t),this.compare(a,t)&&(this.setModified(e),this.data[e]=t,this.modified=!0,i.onChange)){let i=this._prepareRecord(this.raw);i[e]=t,this.dataSource.dispatchEvent("field_change_event",[e,i])}}return!0}$new(){return e(this.raw)}toObject(){let e=jQuery.extend({},this.data);this.pk&&(e.id=this.pk);for(let i of this.children)i.scope.fieldName in e||(e[i.scope.fieldName]=[]),i.state===t.created?e[i.scope.fieldName].push({action:"CREATE",values:i.toObject()}):i.state===t.modified?e[i.scope.fieldName].push({action:"UPDATE",values:i.toObject()}):i.state===t.destroyed&&e[i.scope.fieldName].push({action:"DESTROY",id:i.pk});return e}}class t{static initClass(){this.destroyed="destroyed",this.created="created",this.modified="modified"}}t.initClass(),Katrid.Data.RecordState=t,Katrid.Data.createRecord=function(t,i){return new e(t,i),new Proxy(t,{set(e,a,s,r){let n=i.scope;return a.startsWith("$$")||!a.startsWith("$")&&n&&t.$record.set(a,s),Reflect.set(e,a,s,r)}})},Katrid.Data.SubRecords=class{constructor(e){this.recs=e}append(e){-1===this.recs.indexOf(e)&&this.recs.push(e)}}}(),function(){class e{static initClass(){this.inserting="inserting",this.browsing="browsing",this.editing="editing",this.loading="loading",this.inactive="inactive"}}e.initClass(),DEFAULT_REQUEST_INTERVAL=300;Katrid.Data.DataSource=class{constructor(e){this.readonly=!1,this.$modifiedRecords=[],this.scope=e,this.action=e.action,this._recordIndex=0,this.recordCount=null,this.loading=!1,this.loadingRecord=!1,this._masterSource=null,this.pageIndex=0,this.pageLimit=100,this.offset=0,this.offsetLimit=0,this.requestInterval=DEFAULT_REQUEST_INTERVAL,this.pendingRequest=null,this.fieldName=null,this.children=[],this.modifiedData=null,this.uploading=0,this._state=null,this.fieldWatchers=[],this._pendingChanges=!1}addFieldWatcher(e){}get fields(){return this.scope.view.fields}get loadingAction(){return this._loadingAction}set loadingAction(e){this.requestInterval=e?0:DEFAULT_REQUEST_INTERVAL,this._loadingAction=e}async cancel(){if(this.changing){for(let e of this.children)e.cancel();this._recordIndex=null,this._pendingChanges=!1,this.state===e.inserting&&Katrid.settings.ui.goToDefaultViewAfterCancelInsert?(this.record={},this.scope.action.viewType="list"):this.state===e.editing?this.scope.record&&(await this.refresh([this.scope.record.id]),this.state=e.browsing,this.recordId=this.record.id):(this.record={},this.state=e.browsing)}}saveAndClose(){const e=this.saveChanges(!1);if(e&&$.isFunction(e.promise))return e.then(e=>(e.ok&&e.result&&(this.scope.result=e.result),$(this.scope.root).closest(".modal").modal("toggle")))}async copy(t){let i=await this.model.copy(t);return this.record={},this.state=e.inserting,this.setValues(i),this.scope.$apply(),i}findById(e){for(let t of this.scope.records)if(t.id===e)return t;return null}hasKey(e){return null!==this.findById(e)}refresh(e){let t;return(t=e?this.get(e[0]):this.scope.record.id?this.get(this.scope.record.id):this.search(this._params,this._page)).then(()=>{for(let e in this.children)e.invalidate&&(e.invalidate(this.recordId),e.scope.$apply())}),t}_validateForm(e,t,i){let a;for(let s in t.$error)if("required"===s)for(let r of Array.from(t.$error[s]))if(r.$name.startsWith("grid-row-form"))a=this._validateForm(e.find("#"+r.$name),r,i);else{(a=e.find(`.form-field[name="${r.$name}"]`)).addClass("ng-touched");const t=angular.element(e).scope().view.fields[r.$name];i.push(`<span>${t.caption}</span><ul><li>${Katrid.i18n.gettext("This field cannot be empty.")}</li></ul>`)}else console.log(t.$error[s]);return a}validate(){if(console.log("validate",this.scope.form.$error),this.scope.form.$invalid){let e,t=[],i=`<span>${Katrid.i18n.gettext("The following fields are invalid:")}</span><hr>`;const a=this.scope.formElement;return e=this._validateForm(a,this.scope.form,t),Katrid.ui.uiKatrid.setFocus(e),i+=t.join(""),Katrid.ui.Dialogs.Alerts.error(i),console.log(i),!1}return!0}indexOf(e){return this.scope.records.indexOf(this.findById(e.id))}search(e,t,i,a){if(this.masterSource,this.groups&&!this.groups.length&&this.scope.defaultGrouping){let e={context:{grouping:[this.scope.defaultGrouping]}};return void this.groupBy(e)}this._params=e,this._page=t,this._clearTimeout(),this.pendingRequest=!0,this.loading=!0,t=t||1,this.pageIndex=t;let{domain:s}=this.scope.action.info;return s&&(s=JSON.parse(s)),e={count:!0,page:t,params:e,fields:i,domain:s,limit:this.limit},new Promise((t,i)=>{let s=()=>{this.model.search(e).catch(e=>i(e)).then(e=>(this.pageIndex>1?this.offset=(this.pageIndex-1)*this.pageLimit+1:this.offset=1,this.scope.$apply(()=>{null!=e.count&&(this.recordCount=e.count);let t=e.data;return this.readonly?this.scope.records=t:this.scope.records=t.map(e=>Katrid.Data.createRecord(e,this)),1===this.pageIndex?this.offsetLimit=this.scope.records.length:this.offsetLimit=this.offset+this.scope.records.length-1}),t(e))).finally(()=>{this.pendingRequest=!1,this.scope.$apply(()=>{this.loading=!1})})};(this.requestInterval>0||a)&&!1!==a?this.pendingRequest=setTimeout(s,this.requestInterval):s()})}groupBy(e){if(e)return this.scope.groupings=[],this.groups=[e],this.model.groupBy(e.context).then(t=>{this.scope.records=[];const i=e.context.grouping[0];for(let a of Array.from(t)){let t=a[i];$.isArray(t)?(a._paramValue=t[0],t=t[1]):a._paramValue=t,a.__str__=t,a.expanded=!1,a.collapsed=!0,a._searchGroup=e,a._paramName=i,a._domain={},a._domain[a._paramName]=a._paramValue;const s={_group:a,_hasGroup:!0};let r=a;this.scope.groupings.push(r),this.autoLoadGrouping&&(e=>{this.model.search({params:a._domain}).then(t=>{t.ok&&this.scope.$apply(()=>{e.records=t.result.data})})})(r),this.scope.records.push(s)}return this.scope.$apply()});this.groups=[]}goto(e){return this.recordIndex=e}moveBy(e){const t=this._recordIndex+e;t>-1&&t<this.scope.records.length&&(this.recordIndex=t)}_clearTimeout(){this.loading=!1,this.loadingRecord=!1,this._canceled=!0,clearTimeout(this.pendingRequest)}set masterSource(e){this._masterSource=e,e.children.push(this)}get masterSource(){return this._masterSource}applyModifiedData(e,t,i){const a=this.getModifiedData(e,t,i),s=_.hash(i);if(a){let e=this.modifiedData;null==e&&(e={});let t=e[s];t||(t={},e[s]=t);for(let e in a){const i=a[e];t[e]=i}this.modifiedData=e,this.masterSource.scope.form.$setDirty()}return a}getNestedData(){let e={};for(let t of this.children)if(t.$modifiedRecords.length){let i=[],a=[];for(let e of t.$modifiedRecords)e.$deleted&&(a.push(e),null!==e.id&&void 0!==e.id&&i.push({id:e.id,action:"DESTROY"}));for(let e of t.$modifiedRecords)if(console.log(e.$modified,e.$modifiedData),e.$modifiedData&&!e.$deleted&&e.$modified&&-1===a.indexOf(e)){let a=this._getModified(e.$modifiedData);e.id&&(a.id=e.id),jQuery.extend(a,t.getNestedData()),null===e.id||void 0===e.id?i.push({action:"CREATE",values:a}):null!==e.id&&void 0!==e.id&&i.push({action:"UPDATE",values:a})}Object.keys(i).length>0&&(e[t.fieldName]=i)}return e}save(t=!0){for(let e of this.children)e.changing&&e.scope.save();const i=this.scope.formElement;if(this.validate()){const a=this.record.$record.toObject();this.scope.form.data=a;let s=i.attr("before-submit");if(s&&(s=this.scope.$eval(s)),a)return this.uploading++,this.model.write([a]).then(i=>{if(this.scope.action.location.search("id",i[0]),this.scope.form.$setPristine(),this.scope.form.$setUntouched(),this._pendingChanges=!1,this.state=e.browsing,t)return this.refresh(i)}).catch(e=>{let t=`<span>${Katrid.i18n.gettext("The following fields are invalid:")}<hr></span>`;if(e.message)t=e.message;else if(e.messages){let a;for(let s of Object.keys(e.messages)){const r=e.messages[s];let n;if(s.indexOf(".")>-1){let e=(s=s.split("."))[1];for(let t of this.children)t.scope.fieldName===s[0]&&(n=t.scope.view.fields[e])}else n=this.scope.view.fields[s];if(console.log("field invalid",n),n&&n.name){(a=i.find(`.form-field[name="${n.name}"]`)).addClass("ng-invalid ng-touched"),t+=`<strong>${n.caption}</strong><ul>`;for(let e of r)t+=`<li>${e}</li>`;t+="</ul>"}}a&&a.focus()}return Katrid.ui.Dialogs.Alerts.error(t)}).finally(()=>this.scope.$apply(()=>this.uploading--));Katrid.Dialogs.Alerts.warn(Katrid.i18n.gettext("No pending changes"))}}_getNested(e){let t,i=[];if(e.$deleted&&e.$deleted.recs.length)for(let t of e.$deleted.recs)i.push({id:t.id,action:"DESTROY"});if(e.recs.length)for(let a of e.recs)if(a){if(t={},a.$created)t={action:"CREATE",values:this._getModified(a.$modifiedData)};else{if(!a.$modified)continue;(t={action:"UPDATE",values:this._getModified(a.$modifiedData)}).values.id=a.id}i.push(t)}return i}_getModified(e){let t={};if(e)for(let[i,a]of Object.entries(e))a instanceof Katrid.Data.SubRecords?t[i]=this._getNested(a):t[i]=a;return t}getModifiedData(e,t,i){let a={};return i.$modified&&jQuery.extend(a,this._getModified(i.$modifiedData)),this.record.id&&(a.id=i.id),a}get(t,i,a=!0,s=!1){return this._clearTimeout(),this.state=e.loading,this.loadingRecord=!0,this._canceled=!1,new Promise((r,n)=>{const o=()=>this.model.getById(t).catch(e=>n(e)).then(t=>{if(!this._canceled&&t){if(this.state===e.loading)this.state=e.browsing;else if(this.state===e.inserting)return;return this.record=t.data[0],!1!==s&&(this.scope.records[s]=this.record),r(this.record)}}).finally(()=>{if(this.loadingRecord=!1,a)return this.scope.$apply()});if(!i&&!this.requestInterval)return o();this.pendingRequest=setTimeout(o,i||this.requestInterval)})}async insert(){this._clearTimeout();for(let e of this.children)e._clearTimeout();let t={$created:!0},i=this.scope.records;this.record=t,this.scope.records=i;let a=await this.model.getDefaults();for(let e of this.children)e.scope.records=[];this.state=e.inserting,this.scope.record.display_name=Katrid.i18n.gettext("(New)"),a&&this.setValues(a)}_new(){return Katrid.Data.createRecord({},this)}setValues(e){Object.entries(e).forEach(([e,t])=>{let i=this.action.scope.view.fields[e];i?i.fromJSON(t,this):this.scope.record[e]=t}),this.scope.$apply()}edit(){this.state=e.editing}toClientValue(e,t){const i=this.scope.view.fields[e];return i&&"DateTimeField"===i.type&&(t=new Date(t)),t}fieldByName(e){return this.scope.view.fields[e]}set state(t){this._modifiedFields=[],this._state=t,this.inserting=t===e.inserting,this.editing=t===e.editing,this.loading=t===e.loading,this.changing=[e.editing,e.inserting].includes(this.state),this.changing&&setTimeout(()=>{if(this.action.$element)for(let e of Array.from(this.action.$element.find("input[type!=hidden].form-field:visible")))if(!(e=$(e)).attr("readonly"))return void $(e).focus()})}get browsing(){return this._state===e.browsing}childByName(e){for(let t of this.children)if(t.fieldName===e)return t}get state(){return this._state}get record(){return this.scope.record}set recordId(e){this.scope.recordId=e,this.scope.$broadcast("masterChanged",this,e)}get recordId(){return this.scope.recordId}set record(e){this.scope.record=Katrid.Data.createRecord(e,this),this.recordId=e.id,this._pendingChanges=!1,this.scope.form&&this.scope.form.$setPristine()}next(){return this.moveBy(1)}prior(){return this.moveBy(-1)}nextPage(){let e=this.recordCount/this.pageLimit;if(Math.floor(e)&&e++,e>this.pageIndex+1)return this.scope.action.location.search("page",this.pageIndex+1)}prevPage(){if(this.pageIndex>1)return this.scope.action.location.search("page",this.pageIndex-1)}set recordIndex(e){if(this._recordIndex=e,!this.masterSource)return this.action.location.search("id",this.scope.records[e].id);this.scope.record=this.scope.records[e],this.scope.recordId=null}get recordIndex(){return this._recordIndex}expandGroup(e,t){const i=t._group,a={params:{}};return a.params[i._paramName]=i._paramValue,this.model.search(a).then(t=>{if(t.ok&&t.result.data)return this.action.scope.$apply(()=>(i._children=t.result.data,this.action.scope.records.splice.apply(this.scope.records,[e+1,0].concat(t.result.data))))})}collapseGroup(e,t){const i=t._group;return this.scope.records.splice(e+1,i._children.length),delete i._children}_applyResponse(e){e.value&&this.setValues(e.value),this.scope.$apply()}async dispatchEvent(e,...t){let i=await this.model.rpc(e,...t);this._applyResponse(i)}get model(){return this.scope.model}get parent(){return this.masterSource}$setDirty(e){this.scope.$setDirty(e)}},Katrid.Data.DataSourceState=e}(),function(){class e{constructor(e){this.cols=e.cols||6,this.visible=!0,this._info=e,this.caption=this._info.caption,this.helpText=this._info.help_text,this.onChange=this._info.onchange,this.required=this._info.required,!1===this._info.visible&&(this.visible=!1),this.readonly=this._info.readonly,this.readonly||(this.readonly=!1),this.displayChoices=_.object(e.choices),this.choices=e.choices,e.choices?this.template={list:"view.list.selection-field.pug",form:"view.form.selection-field.pug"}:this.template={list:"view.list.field.pug",form:"view.form.field.pug"},e._listChoices&&console.log(e._listChoices),e.template&&(this.template=Object.assign(this.template,e.template)),this.emptyText="--"}static fromInfo(e){return new(Katrid.Data.Fields[e.type]||t)(e)}static fromArray(e){let t={};return Object.keys(e).map(i=>t[i]=this.fromInfo(e[i])),t}assign(e){this.$el=e,this.caption=e.attr("label")||this.caption;let t=e.attr("ng-readonly");_.isUndefined(t)||(this.ngReadonly=t);let i=e.attr("cols");_.isUndefined(i)||(this.cols=i)}fromJSON(e,t){t.record[this.name]=e}get validAttributes(){return["name","nolabel","readonly","required"]}getAttributes(e){let t={},i=this.validAttributes;for(let[a,s]of Object.entries(e.$attr))i.includes(s)&&(t[s]=e[a],""===t[s]&&(t[s]=s));return this.ngReadonly?t["ng-readonly"]=this.ngReadonly:this.readonly&&(t.readonly=this.readonly),t["ng-model"]="record."+this.name,e.ngFieldChange&&(t["ng-change"]=e.ngFieldChange,console.log("change",e.ngFieldChange)),this.required&&(t.required=this.required),t}get hasChoices(){return this._info.choices&&this._info.choices.length>0}get name(){return this._info.name}get model(){return this._info.model}get maxLength(){return this._info.max_length}get type(){return this._info.type}get paramTemplate(){return"view.param.String"}format(e){return e.toString()}toJSON(e){return e}createWidget(e,t,i,a){return e||this.hasChoices&&(e="SelectionField"),new(Katrid.ui.Widgets[e||this.type]||Katrid.ui.Widgets.StringField)(t,i,this,a)}validate(){}get defaultCondition(){return"="}isControlVisible(e){switch(e){case"is null":case"is not null":return!1}return!0}}class t extends e{constructor(e){e.cols||(e.cols=3),super(...arguments)}}class i extends e{constructor(e){e.cols||(e.cols=3),super(...arguments),this.template.form="view.form.date-field.pug",this.template.list="view.list.date-field.pug"}toJSON(e){return e}get paramTemplate(){return"view.param.Date"}format(e){return _.isString(e)?moment(e).format(Katrid.i18n.gettext("yyyy-mm-dd").toUpperCase()):""}getAttributes(e){let t=super.getAttributes(e);return t.type="date",t}}class a extends e{constructor(e){e.cols||(e.cols=3),super(...arguments),Katrid.ui.isMobile?this.template.form="view.form.numpad-field.pug":this.template.form="view.form.numeric-field.pug",this.template.list="view.list.numeric-field.pug"}toJSON(e){return e&&_.isString(e)?parseFloat(e):e}}class s extends e{constructor(e){super(...arguments),this.domain=e.domain,Object.assign(this.template,{list:"view.list.foreignkey.pug",form:"view.form.foreignkey.pug"})}assign(e){super.assign(e);let t=$(e).attr("domain");t&&(this.domain=t)}toJSON(e){return _.isArray(e)?e[0]:e}get validAttributes(){return super.validAttributes.concat(["domain"])}}Katrid.Data.Fields={Field:e,StringField:t,IntegerField:class extends e{constructor(e){e.cols||(e.cols=3),super(...arguments)}toJSON(e){return e&&_.isString(e)?parseInt(e):e}get paramTemplate(){return"view.param.Integer"}},FloatField:class extends a{},DecimalField:class extends a{constructor(){super(...arguments),this.decimalPlaces=2,this._info.attrs&&(this.decimalPlaces=this._info.attrs.decimal_places||2)}},DateTimeField:class extends i{get paramTemplate(){return"view.param.DateTime"}getAttributes(e){let t=super.getAttributes(e);return t.type="datetime-local",t}},ForeignKey:s,OneToManyField:class extends e{constructor(e){e.cols||(e.cols=12),super(...arguments),this.template.form="view.form.grid.pug"}get field(){return this._info.field}get validAttributes(){return super.validAttributes.concat(["inline-editor"])}fromJSON(e,t){e&&e instanceof Array&&e.map(e=>{"CLEAR"===e.action?t.childByName(this.name).scope.records=[]:"CREATE"===e.action&&t.childByName(this.name).scope.addRecord(e.values)})}},ManyToManyField:class extends s{toJSON(e){return _.isArray(e)?e.map(e=>_.isArray(e)?e[0]:e):(_.isString(e)&&(e=e.split(",")),e)}},TextField:class extends t{constructor(e){super(...arguments),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.text-field.pug")}},DateField:i,BooleanField:class extends e{constructor(e){e.cols||(e.cols=3),e.template||(e.template={}),e.template.form||(e.template.form="view.form.boolean-field.pug"),super(...arguments)}get paramTemplate(){return"view.param.Boolean"}},ImageField:class extends e{constructor(e){e.template||(e.template={}),e.template.form||(e.template.form="view.form.image-field.pug"),super(...arguments),this.noImageUrl="/static/web/assets/img/no-image.png"}getAttributes(e){let t=super.getAttributes(e);return t.ngSrc=e.ngEmptyImage||e.emptyImage&&`'${e.emptyImage}`||`'${this.noImageUrl}'`,t.ngSrc=`{{ ${t["ng-model"]} || ${t.ngSrc} }}`,t}}}}(),Katrid.ui={Keyboard:{keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}},toggleFullScreen(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}},Katrid.ui.uiKatrid=angular.module("ui.katrid",[]),function(){class e{static initClass(){this.actionType=null}constructor(e,t,i){Katrid.app.actionManager.addAction(this),this.info=e,this.scope=t,this.location=i,this.currentUrl=this.location.$$path}getContext(){let e;return _.isString(this.info.context)&&(e=JSON.parse(this.info.context)),e||(e={}),e}doAction(e){let t=e.type||e.action_type;return Katrid.Actions[t].dispatchAction(this,e)}openObject(e,t,i){if(this._unregisterHook&&this._unregisterHook(),i.preventDefault(),i.stopPropagation(),i.ctrlKey)return window.open(i.target.href),!1;const a=`action/${e}/view/`;return this.location.path(a,this).search({view_type:"form",id:t}),!1}restore(){}apply(){}backTo(e,t){this._currentPath!==this._unregisterHook&&Katrid.app.actionManager.length>1&&this._unregisterHook();let i,a=Katrid.app.actionManager[e];if(0===e&&0===t)return a.restore(a.searchViewType||a.viewModes[0]);if(0===e&&"form"===t)return a.restore("form");Katrid.app.actionManager.action=a,t||(t="form"),i=a.currentUrl,a.info.__cached=!0;let s=this.location.path(i,!0,a.info),r=a._currentParams[t];console.log("search",r),r&&s.search(r)}execute(){}getCurrentTitle(){return this.info.display_name}search(){if(!this.isDialog)return this.location.search.apply(null,arguments)}}e.initClass();class t extends e{static initClass(){this.actionType="ir.action.view"}routeUpdate(e){return Katrid.core.setContent(this.info.content,this.scope)}}t.initClass();class i extends e{static initClass(){this.actionType="ir.action.url"}constructor(e,t,i){super(e,t,i),window.location.href=e.url}}i.initClass(),Katrid.Actions={Action:e,ViewAction:t,UrlAction:i,ActionManager:class extends Array{constructor(){super(),this.mainAction=null}addAction(e){this.mainAction||(this.mainAction=e),this.push(e)}removeAction(e){this.splice(this.indexOf(e),this.length)}get action(){return this[this.length-1]}set action(e){this.splice(this.indexOf(e)+1,this.length)}clear(){this.length=0,this.mainAction=null}get path(){return this.action.path}doAction(e){}get context(){return this.action.getContext()}}},Katrid.Actions[t.actionType]=t,Katrid.Actions[i.actionType]=i}(),function(){class e extends Katrid.Actions.Action{static initClass(){this.actionType="ir.action.client",this.registry={}}static register(e,t){this.registry[e]=t}static executeTag(e,t){let i=this.registry[t.tag];i.prototype instanceof Katrid.UI.Views.ActionView?(i=new i(e.scope)).renderTo(e):console.log("is a function")}static tagButtonClick(t){let i={type:"ir.action.client",tag:t.attr("name"),target:t.attr("target")||"new"};(i=new e(i,Katrid.Actions.actionManager.action.scope,Katrid.Actions.actionManager.action.location)).execute()}tag_refresh(){this.dataSource.refresh()}get templateUrl(){return console.log(this.tag),this.tag.templateUrl}execute(){let t=e.registry[this.info.tag];if(this.tag=t,t.prototype instanceof Katrid.ui.Views.ClientView){this.tag=new t(this),console.log(this.scope);let e=this.tag.render();"new"===this.info.target&&(e=e.modal(),e=Katrid.core.compile(e)(this.scope))}else _.isString(t)&&this[t].apply(this)}async routeUpdate(e){}get template(){return this.tag.template}}e.initClass(),Katrid.Actions.ClientAction=e,Katrid.Actions[e.actionType]=e}(),function(){class e extends Katrid.Actions.Action{static initClass(){this.actionType="ir.action.window"}constructor(e,t,i){super(e,t,i),this.templateUrl="ir.action.window.pug",this.notifyFields=[],this.viewMode=e.view_mode,this.viewModes=this.viewMode.split(","),this.selectionLength=0,this._cachedViews={},this._currentParams={},this._currentPath=null,this.searchView=null}getContext(){let e=super.getContext(),t=this.selection;return t&&t.length&&(e.active_id=t[0],e.active_ids=t),e}restore(e){this._currentPath||this.location.$$path;let t=this._currentParams[e]||{};t.view_type=e,Katrid.app.actionManager.length>1?(console.log(this.info),t.actionId=this.info.id,this.$state.go("actionView",t)):this.viewType=e}getCurrentTitle(){return"form"===this.viewType?this.scope.record.display_name:super.getCurrentTitle()}createNew(){this.viewType="form",setTimeout(async()=>{try{Katrid.ui.Dialogs.WaitDialog.show(),await this.dataSource.insert()}finally{Katrid.ui.Dialogs.WaitDialog.hide()}})}deleteSelection(){let e=this.selection;if(!e)return!1;if(1===e.length&&confirm(Katrid.i18n.gettext("Confirm delete record?"))||e.length>1&&confirm(Katrid.i18n.gettext("Confirm delete records?"))){this.model.destroy(e);this.scope.records.indexOf(this.scope.record);this.setViewType("list"),this.dataSource.refresh()}}async copy(){return this.setViewType("form"),await this.dataSource.copy(this.scope.record.id),!1}async routeUpdate(e){const t=this.viewType;let i=this._currentViewType;if(null!=t){if(null==this.scope.records&&(this.scope.records=[]),this.viewType!==i&&(this.dataSource.pageIndex=null,this.dataSource.record={},this.viewType=t,this._currentViewType=this.viewType),Katrid.ui.Views.searchModes.includes(this.viewType)&&e.page!==this.dataSource.pageIndex){const t=this.searchParams||{},i=Object.keys(this.view.fields);this.dataSource.pageIndex=parseInt(e.page),this.dataSource.limit=parseInt(e.limit||this.info.limit),await this.dataSource.search(t,this.dataSource.pageIndex||1,i)}else e.id&&this.dataSource.recordId!==e.id&&(this.scope.record=null,this.dataSource.get(e.id));null==e.page&&"form"!==this.viewType&&(this.location.search("page",1),console.log("set limit",this._viewType),this.location.search("limit",this.info.limit))}e.view_type!==this.viewType&&(this.viewType=e.view_type),this._currentParams[this.viewType]=jQuery.extend({},e),this._currentPath=this.location.$$path,e.title&&(this.info.display_name=e.title)}switchView(e){}get dataSource(){return this.scope.dataSource}apply(){if(this.viewModes.length){let e=[];for(let[t,i]of Object.entries(this.views)){let a=Katrid.ui.Views[t];if(a){let s=new a(this,this.scope,i,i.content);this._cachedViews[t]=s;let r=s.render();_.isString(r)||(r=r[0].outerHTML),e.push(`<div class="action-view" ng-if="action.viewType === '${t}'">${r}</div>`)}}this._template=e.join("")}else{let e=new(0,Katrid.UI.Views[this.viewType])(this,this.scope,this.view,this.view.content);this._cachedViews[this.viewType]=e,this._template=e.render()}}async execute(){if(!this.views){let e=await this.model.loadViews({views:this.info.views,action:this.info.id,toolbar:!0});this.fields=e.fields,this.fieldList=e.fieldList,this.views=e.views}}get viewType(){return this._viewType}set viewType(e){e||(e=this.viewModes[0]),e!==this._viewType&&(this._viewType||(this.searchViewType=this.viewModes[0]),this.view=this.views[e],this._viewType=e,this.switchView(e),this.scope.$$phase||this.scope.$apply(),this.location.$$search.view_type!==e&&this.location.search({view_type:e}))}set view(e){this._view=e,this.scope&&(this.scope.view=e)}get view(){return this._view}searchText(e){return this.location.search("q",e)}_prepareParams(e){const t={};for(let i of Array.from(e))i.field&&"ForeignKey"===i.field.type?t[i.field.name]=i.id:t[i.id.name+"__icontains"]=i.text;return t}setSearchParams(e){let t={};this.info.domain&&(t=$.parseJSON(this.info.domain));for(let[i,a]of Object.entries(t)){let t={};t[i]=a,e.push(t)}return this.dataSource.search(e)}applyGroups(e){return this.dataSource.groupBy(e[0])}doViewAction(e,t,i,a){return this._doViewAction(this.scope,e,t,i,a)}_doViewAction(e,t,i,a,s){let r=null;if(s&&(r=window.prompt(s)),!a||a&&confirm(a))return this.model.doViewAction({action_name:t,target:i,prompt:r}).then(function(e){let t,i;return"open"===e.status?window.open(e.open):"fail"===e.status?(()=>{for(t of(i=[],Array.from(e.messages)))i.push(Katrid.Dialogs.Alerts.error(t));return i})():"ok"===e.status&&e.result.messages?(()=>{const i=[];for(t of Array.from(e.result.messages))i.push(Katrid.Dialogs.Alerts.success(t));return i})():void 0})}async formButtonClick(e,t,i){const a=await this.scope.model.post(t,{kwargs:{id:e}});if(a.open)return window.open(a.open);if("refresh"===a.tag&&this.dataSource.refresh(),a.type){new Katrid.Actions[a.type](a,this.scope,this.scope.location).execute()}}doBindingAction(e){this.selection,Katrid.Services.Actions.load($(e.currentTarget).data("id")).then(e=>{"ir.action.report"===e.action_type&&Katrid.Actions.ReportAction.dispatchBindingAction(this,e)})}listRowClick(e,t,i){const a={view_type:"form",id:t.id,actionId:this.info.id};if(i.ctrlKey){const e=`#${this.location.$$path}?${$.param(a)}`;window.open(e)}else t._group?(t._group.expanded=!t._group.expanded,t._group.collapsed=!t._group.expanded,t._group.expanded?this.dataSource.expandGroup(e,t):this.dataSource.collapseGroup(e,t)):(this.dataSource.recordIndex=e,this.viewType="form",this.$state.go(".",a,{inherit:!1}))}autoReport(){return this.model.autoReport().then(function(e){if(e.ok&&e.result.open)return window.open(e.result.open)})}showDefaultValueDialog(){const e=Katrid.UI.Utils.Templates.getSetDefaultValueDialog();$(Katrid.core.compile(e)(this.scope)).modal().on("hidden.bs.modal",function(){return $(this).data("bs.modal",null),$(this).remove()})}selectToggle(e){this._selection=$(e).closest("table").find("td.list-record-selector :checkbox").filter(":checked"),this.selectionLength=this._selection.length}get selection(){return"form"===this.viewType?this.scope.recordId?[this.scope.recordId]:void 0:this._selection?Array.from(this._selection).map(e=>$(e).data("id")):void 0}deleteAttachment(e,t){let i=e[t];confirm(Katrid.i18n.gettext("Confirm delete attachment?"))&&(e.splice(t,1),Katrid.Services.Attachments.destroy(i.id))}}e.initClass(),Katrid.Actions.WindowAction=e,Katrid.Actions[e.actionType]=e}(),function(){class e extends Katrid.Actions.Action{static initClass(){this.actionType="ir.action.report"}static async dispatchBindingAction(e,t){let i=localStorage.katridReportViewer||"pdf",a=e.selection;console.log("selection ",a),a&&(a=a.join(","));let s={data:[{name:"id",value:a}]};const r=new Katrid.Services.Model("ir.action.report");let n=await r.post("export_report",{args:[t.id],kwargs:{format:i,params:s}});if(n.open)return window.open(n.open)}constructor(e,t,i){super(e,t,i),this.templateUrl="view.report",this.userReport={}}userReportChanged(e){return this.location.search({user_report:e})}async routeUpdate(e){if(this.userReport.id=e.user_report,this.userReport.id){const e=new Katrid.Services.Model("ir.action.report");let t=await e.post("load_user_report",{kwargs:{user_report:this.userReport.id}});this.userReport.params=t.result}}get template(){return Katrid.Reports.Reports.renderDialog(this)}}e.initClass(),Katrid.Actions.ReportAction=e,Katrid.Actions[e.actionType]=e}(),function(){let e=0;class t{static initClass(){this.currentReport={},this.currentUserReport={}}static get(e){}static renderDialog(e){return Katrid.app.getTemplate("view.report")}}t.initClass();class i{constructor(t,i){this.action=t,this.scope=i,this.info=this.action.info,Katrid.Reports.Reports.currentReport=this,null==a.Labels&&(a.Labels={exact:Katrid.i18n.gettext("Is equal"),in:Katrid.i18n.gettext("Selection"),contains:Katrid.i18n.gettext("Contains"),startswith:Katrid.i18n.gettext("Starting with"),endswith:Katrid.i18n.gettext("Ending with"),gt:Katrid.i18n.gettext("Greater-than"),lt:Katrid.i18n.gettext("Less-than"),between:Katrid.i18n.gettext("Between"),isnull:Katrid.i18n.gettext("Is Null")}),this.name=this.info.name,this.id=++e,this.values={},this.params=[],this.filters=[],this.groupables=[],this.sortables=[],this.totals=[]}getUserParams(){const e={data:[],file:this.container.find("#id-report-file").val()};for(let t of Array.from(this.params))e.data.push({name:t.name,op:t.operation,value1:t.value1,value2:t.value2,type:t.type});const t=this.container.find("#report-id-fields").val();e.fields=t;const i=this.container.find("#report-id-totals").val();e.totals=i;const a=this.container.find("#report-id-sorting").val();e.sorting=a;const s=this.container.find("#report-id-grouping").val();return e.grouping=s,e}loadFromXml(e){_.isString(e)&&(e=$(e)),this.scope.customizableReport=e.attr("customizableReport"),this.scope.advancedOptions=e.attr("advancedOptions");const t=[];for(let i of Array.from(e.find("field"))){const e=(i=$(i)).attr("name"),a=i.attr("label")||this.info.fields[e]&&this.info.fields[e].caption||e,s=i.attr("groupable"),r=i.attr("sortable"),n=i.attr("total"),o=i.attr("param"),l=i.attr("required"),d=i.attr("autoCreate")||l,c=i.attr("operation");let p=i.attr("type");const h=i.attr("model-choices");!p&&h&&(p="ModelChoices"),t.push({name:e,label:a,groupable:s,sortable:r,total:n,param:o,required:l,operation:c,modelChoices:h,type:p,autoCreate:d})}const i=Array.from(e.find("param")).map(e=>$(e).attr("name"));return this.load(t,i)}saveDialog(){const e=this.getUserParams(),t=window.prompt(Katrid.i18n.gettext("Report name"),Katrid.Reports.Reports.currentUserReport.name);return t&&(Katrid.Reports.Reports.currentUserReport.name=t,$.ajax({type:"POST",url:this.container.find("#report-form").attr("action")+"?save="+t,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(e)})),!1}load(e,t){e||({fields:e}=this.info),t||(t=[]),this.fields=e;for(let i of e)i.groupable&&this.groupables.push(i),i.sortable&&this.sortables.push(i),i.total&&this.totals.push(i),i.autoCreate||(i.autoCreate=t.includes(i.name))}loadParams(){for(let e of Array.from(this.fields))e.autoCreate&&this.addParam(e.name)}addParam(e){for(let t of Array.from(this.fields))if(t.name===e){t=new s(t,this),this.params.push(t);break}}getValues(){}export(e){null==e&&(e=localStorage.katridReportViewer||"pdf");const t=this.getUserParams();return new Katrid.Services.Model("ir.action.report").post("export_report",{args:[this.info.id],kwargs:{format:e,params:t}}).then(function(e){if(e.open)return window.open(e.open)}),!1}preview(){return this.export(localStorage.katridReportViewer)}renderFields(){let e,t=$("<div></div>");const i=this.fields.map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),a=(()=>{const t=[];for(e of Array.from(this.fields))e.total&&t.push(`<option value="${e.name}">${e.label}</option>`);return t})().join("");let s=(t=this.container.find("#report-params")).find("#report-id-fields");return s.append($(i)).select2({tags:(()=>{const t=[];for(e of Array.from(this.fields))t.push({id:e.name,text:e.label});return t})()}).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>s.select2("onSortStart"),update:()=>s.select2("onSortEnd")}),Katrid.Reports.Reports.currentUserReport.params&&Katrid.Reports.Reports.currentUserReport.params.fields&&(console.log(Katrid.Reports.Reports.currentUserReport.params.fields),s.select2("val",Katrid.Reports.Reports.currentUserReport.params.fields)),(s=t.find("#report-id-totals")).append(a).select2({tags:(()=>{const t=[];for(e of Array.from(this.fields))e.total&&t.push({id:e.name,text:e.label});return t})()}).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>s.select2("onSortStart"),update:()=>s.select2("onSortEnd")}),t}renderParams(e){let t;const i=$("<div></div>");this.elParams=i;const a={},s=Katrid.Reports.Reports.currentUserReport.params;if(s&&s.data)for(t of Array.from(s.data))a[t.name]=!0,this.addParam(t.name,t.value);for(t of Array.from(this.params))t.static&&!a[t.name]&&$(t.render(i));return e.find("#params-params").append(i)}renderGrouping(e){const t=Array.from(this.groupables).map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),i=e.find("#params-grouping").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>i.select2("onSortStart"),update:()=>i.select2("onSortEnd")})}renderSorting(e){const t=Array.from(this.sortables).filter(e=>e.sortable).map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),i=e.find("#params-sorting").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>i.select2("onSortStart"),update:()=>i.select2("onSortEnd")})}render(e){this.container=e;let t=this.renderFields();return this.sortables.length?t=this.renderSorting(e):e.find("#params-sorting").hide(),this.groupables.length?t=this.renderGrouping(e):e.find("#params-grouping").hide(),this.renderParams(e)}}class a{static initClass(){this.Operations={exact:"exact",in:"in",contains:"contains",startswith:"startswith",endswith:"endswith",gt:"gt",lt:"lt",between:"between",isnull:"isnull"},this.DefaultOperations={CharField:this.Operations.exact,IntegerField:this.Operations.exact,DateTimeField:this.Operations.between,DateField:this.Operations.between,FloatField:this.Operations.between,DecimalField:this.Operations.between,ForeignKey:this.Operations.exact,ModelChoices:this.Operations.exact},this.TypeOperations={CharField:[this.Operations.exact,this.Operations.in,this.Operations.contains,this.Operations.startswith,this.Operations.endswith,this.Operations.isnull],IntegerField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],FloatField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],DecimalField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],DateTimeField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],DateField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],ForeignKey:[this.Operations.exact,this.Operations.in,this.Operations.isnull],ModelChoices:[this.Operations.exact,this.Operations.in,this.Operations.isnull]},this.Widgets={CharField:e=>`<div><input id="rep-param-id-${e.id}" ng-model="param.value1" type="text" class="form-control"></div>`,IntegerField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" ng-model="param.value2" type="text" class="form-control"></div>`),`<div class="row"><div class="col-sm-6"><input id="rep-param-id-${e.id}" type="number" ng-model="param.value1" class="form-control"></div>${t}</div>`},DecimalField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" ng-model="param.value2" type="text" class="form-control"></div>`),`<div class="col-sm-6"><input id="rep-param-id-${e.id}" type="number" ng-model="param.value1" class="form-control"></div>${t}`},DateTimeField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" type="datetime-local" ng-model="param.value2" class="form-control"></div>`),`<div class="row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" type="date" ng-model="param.value1" class="form-control"></div>${t}</div>`},DateField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" type="date" ng-model="param.value2" class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" type="date" ng-model="param.value1" class="form-control"></div>${t}</div>`},ForeignKey(e){const t=e.params.info.model;let i="";return"in"===e.operation&&(i="multiple"),`<div><input id="rep-param-id-${e.id}" ajax-choices="/api/rpc/${t}/get_field_choices/" field="${e.name}" ng-model="param.value1" ${i}></div>`},ModelChoices:e=>(console.log("model choices",e),`<div><input id="rep-param-id-${e.id}" ajax-choices="/api/reports/model/choices/" model-choices="${e.info.modelChoices}" ng-model="param.value1"></div>`)}}}a.initClass();class s{constructor(t,i){this.info=t,this.params=i,this.name=this.info.name,this.label=this.info.label,this.field=this.params.info.fields&&this.params.info.fields[this.name],this.static="static"===this.info.param||"static"===this.field.param,this.type=this.info.type||this.field&&this.field.type||"CharField",this.defaultOperation=this.info.operation||a.DefaultOperations[this.type],this.operation=this.defaultOperation,this.operations=this.getOperations(),this.exclude=this.info.exclude,this.id=++e}defaultValue(){return null}setOperation(e,t){null==t&&(t=!0),this.createControls(this.scope);const i=this.el.find(`#rep-param-id-${this.id}`);t&&i.focus()}createControls(e){const t=this.el.find(".param-widget");t.empty();let i=a.Widgets[this.type](this);return i=Katrid.Core.compile(i)(e),t.append(i)}getOperations(){return Array.from(a.TypeOperations[this.type]).map(e=>({id:e,text:a.Labels[e]}))}operationTemplate(){const e=this.getOperations();return`<div class="col-sm-4"><select id="param-op-${this.id}" ng-model="param.operation" ng-init="param.operation='${this.defaultOperation}'" class="form-control" onchange="$('#param-${this.id}').data('param').change();$('#rep-param-id-${this.id}')[0].focus()">\n  ${e}\n  </select></div>`}template(){let e="";return this.operation||(e=this.operationTemplate()),`<div id="param-${this.id}" class="row form-group" data-param="${this.name}" ng-controller="ParamController"><label class="control-label">${this.label}</label>${e}<div id="param-widget-${this.id}"></div></div>`}render(e){return this.el=this.params.scope.compile(this.template())(this.params.scope),this.el.data("param",this),this.createControls(this.el.scope()),e.append(this.el)}}Katrid.ui.uiKatrid.controller("ReportController",["$scope","$element","$compile",function(e,t,a){const s=e.$parent.action.info.content,r=new i(e.$parent.action,e);return e.report=r,console.log(r),r.loadFromXml(s),r.render(t),r.loadParams()}]),Katrid.ui.uiKatrid.controller("ReportParamController",["$scope","$element",function(e,t){return e.$parent.param.el=t,e.$parent.param.scope=e,e.$parent.param.setOperation(e.$parent.param.operation,!1)}]);Katrid.Reports={Reports:t,Report:i,Param:s}}(),(()=>{let e={};Katrid.ui.registerTemplate=function(t,i){e[t]=i},Katrid.ui.Templates=class{constructor(t,i){this.app=t;let a=t.$templateCache.get;t.$templateCache.get=(e=>this.prepare(e,a.call(this,e))),this.loadTemplates(t.$templateCache,i);for(let[i,a]of Object.entries(e))t.$templateCache.put(i,a)}prepare(e,t){if(_.isUndefined(t))throw Error("Template not found: "+e);return"SCRIPT"===t.tagName?t.innerHTML:t}compileTemplate(e,t){let i=$(e);t=$(t.innerHTML);for(let e of Array.from(t))if("JQUERY"===e.tagName){let t=(e=$(e)).attr("selector"),a=e.attr("operation");(t=t?$(i).find(t):i)[a](e[0].innerHTML)}return i[0].innerHTML}loadTemplates(e,t){let i={},a=e=>{"TEMPLATES"===e.tagName?Array.from(e.children).map(a):"SCRIPT"===e.tagName&&(i[e.id]=e.innerHTML)},s=t=>{if("TEMPLATES"===t.tagName)Array.from(t.children).map(s);else if("SCRIPT"===t.tagName){let a=t.getAttribute("extends"),s=t.getAttribute("id")||a;a?t=i[a]+t:s=t.id,e.put(s,t)}},r=(new DOMParser).parseFromString(t,"text/html").firstChild.children[1].firstChild;a(r),s(r)}},Katrid.ui.Templates.PRE_LOADED_TEMPLATES=e})(),(()=>{Katrid.ui.Widgets={Widget:class{},Component:class{}}})(),(()=>{let e=e=>e.find("button").each((e,t)=>{let i=(t=$(t)).attr("type");t.attr("type")&&"object"!==t.attr("type")||t.attr("type","button"),"object"===i?(t.attr("button-object",t.attr("name")),t.attr("ng-click",`action.formButtonClick(record.id, '${t.attr("name")}', $event.target);$event.stopPropagation();`)):"tag"===i&&(t.attr("button-tag",t.attr("name")),t.attr("onclick","Katrid.Actions.ClientAction.tagButtonClick($(this))")),t.attr("class")||t.addClass("btn btn-outline-secondary")});Katrid.ui.uiKatrid.directive("toolbar",class extends Katrid.ui.Widgets.Component{constructor(){super(),this.scope=!1,this.restrict="E",this.replace=!0,this.transclude=!0,this.templateUrl="view.header"}});class t{constructor(e){this.scope=e}render(){return Katrid.app.getTemplate(this.templateUrl)}}class i extends t{constructor(e,t,i,a){super(t),this.action=e,this.view=i,this.templateUrl="view.basic",this.toolbar=!0,this.content=a}getTemplateContext(){return{content:this.content}}render(){return sprintf(Katrid.app.getTemplate(this.templateUrl),this.getTemplateContext())}renderTo(e){Katrid.core.setContent(this.render(),this.scope)}}class a extends i{getBreadcrumb(){let e='<ol class="breadcrumb">',t=0;for(let i of Katrid.app.actionManager)0===t&&i.viewModes.length>1&&(e+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(0, 0)">${i.info.display_name}</a></li>`),t++,Katrid.Actions.actionManager.length>t&&"form"===i.viewType&&(e+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(${t-1}, 'form')">${i.scope.record.display_name}</a></li>`);return"form"===this.constructor.type&&(e+='<li class="breadcrumb-item">{{ self.display_name }}</li>'),e+"</ol>"}render(){return sprintf(Katrid.app.$templateCache.get(this.templateUrl),{content:this.content})}getViewButtons(){let e=Object.entries(a.buttons).map(e=>this.view.viewModes.includes(e[0])?e[1]:"").join("");return e&&(e=`<div class="btn-group">${e}</div>`),e}}class s extends a{constructor(e,t,i,a){super(e,t,i,a),this.templateUrl="view.form"}render(){let e=$(sprintf(Katrid.$templateCache.get(this.templateUrl),{content:this.content,breadcrumb:this.getBreadcrumb(),actions:""}));e.find("form").first().addClass("row");return e}}s.type="form";Katrid.ui.uiKatrid.directive("formView",class{constructor(){this.replace=!0,this.scope=!1}getBreadcrumb(){let e='<ol class="breadcrumb">',t=0;for(let i of Katrid.app.actionManager)0===t&&i.viewModes.length>1&&(e+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(0, 0);$event.preventDefault();">${i.info.display_name}</a></li>`),t++,Katrid.app.actionManager.length>t&&"form"===i.viewType&&(e+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(${t-1}, 'form');$event.preventDefault();">${i.scope.record.display_name}</a></li>`);return(e+='<li class="breadcrumb-item">{{ self.display_name }}</li>')+"</ol>"}template(t){e(t);let i=t.find("header").first(),a="";i.length&&(i.find("field[name=status]").attr("status-field","status-field"),a=i.html(),i.remove()),t.find("field").each((e,t)=>{(t=$(t)).attr("status-field")||t.parents("field").length||t.attr("form-field","form-field")});let s="view.form";return t.attr("form-dialog")&&(s="view.form.dialog"),sprintf(Katrid.app.getTemplate(s),{content:t.html(),breadcrumb:this.getBreadcrumb(),actions:"",header:a})}link(e,t){t.addClass("ng-form"),t.find("form").addClass("row").attr("novalidate","novalidate"),e.$parent.formElement=t.find("form").first(),e.$parent.form=angular.element(e.formElement).controller("form"),new Katrid.Services.Model("ir.copy.to").rpc("get_copy_to_choices",[e.$parent.model.name]).then(function(t){t&&(e.copyToOpts=t)})}}).directive("listView",()=>({replace:!0,template:e=>(e.find("list").attr("list-options",'{"rowSelector": true}').attr("ng-row-click","action.listRowClick($index, record, $event)"),sprintf(Katrid.app.getTemplate("view.list"),{content:e.html()}))})).directive("card",()=>({replace:!0,template:e=>(e.children("field").remove(),e.find("field").each((e,t)=>$(t).replaceWith(`{{ ::record.${$(t).attr("name")} }}`)),sprintf(Katrid.app.getTemplate("view.card"),{content:e.html()}))})),Katrid.ui.Views={View:a,BaseView:t,ActionView:i,FormView:s,ClientView:class{constructor(e){this.action=e}get template(){return Katrid.app.getTemplate(this.templateUrl)}render(){return $(this.template)}},searchModes:["list","card"]},Katrid.ui.Views[s.type]=s})(),function(){Katrid.ui.ViewInfo=class{constructor(e){this._info=e,this.fields=e.fields,this.content=e.content,this.toolbar=e.toolbar}}}(),function(){Katrid.ui.uiKatrid.directive("grid",["$compile",class{constructor(e){this.restrict="E",this.scope={},this.$compile=e}async loadViews(e,t,i,a){let s=await e.model.loadViews(),r=s.views.list.fields[e.field.field];r&&(r.visible=!1);let n=s.views;for(let[e,t]of Object.entries(i))n[e].content=t;e.views=n,e.view=n.list;let o=$(e.view.content);e.inline?o.attr("ng-row-click","editItem($event, $index)").attr("inline-editor",e.inline):o.attr("ng-row-click","openItem($event, $index)"),o.attr("list-options",'{"deleteRow": true}');let l=this.$compile(o)(e);t.html(l),t.prepend(this.$compile(Katrid.app.getTemplate("view.form.grid.toolbar.pug",{attrs:a}))(e)),t.find("table").addClass("table-bordered grid")}async showDialog(e,t,i){if(e.views.form&&await this.renderDialog(e,t),null!=i){e.recordIndex=i;let t=e.records[i];t&&t.$loaded?e.record=t:t&&((await e.dataSource.get(e.records[i].id,0,!1,i)).$loaded=!0)}}async link(e,t,i){const a=e.$parent.view.fields[i.name];e.totalDisplayed=1e3,e.action=e.$parent.action,e.fieldName=i.name,e.field=a,e.records=[],e.recordIndex=-1,e._cachedViews={},e._=e.$parent._,e._changeCount=0,e.dataSet=[],e.parent=e.$parent,e.model=new Katrid.Services.Model(a.model),e.isList=!0,"tabular"===i.inlineEditor?e.inline="tabular":i.hasOwnProperty("inlineEditor")&&(e.inline="inline"),e.getContext=function(){return{}},e.$setDirty=function(){return{}};let s=e.dataSource=new Katrid.Data.DataSource(e);s.readonly=!_.isUndefined(i.readonly);let r=e.$parent;for(;r;){if(r.dataSource){e.dataSource.masterSource=r.dataSource;break}r=r.$parent}e.dataSource.fieldName=e.fieldName,e.gridDialog=null;let n={};for(let e of t.children())if(e.tagName.startsWith("GRID:")){let t=e.tagName.split(":")[1].toLowerCase();e=$(e),n[t]=`<${t}>${e.html()}</${t}>`}function o(e){for(let t=(e=e.replace(/^\s+/,"")).length-1;t>=0;t--)if(/\S/.test(e.charAt(t))){e=e.substring(0,t+1);break}return e}await this.loadViews(e,t,n,i),e.doViewAction=((t,i,a)=>e.action._doViewAction(e,t,i,a)),e._incChanges=(()=>{}),e.addItem=(async()=>{if(await e.dataSource.insert(),!i.$attr.inlineEditor)return this.showDialog(e,i);e.records.splice(0,0,e.record),e.dataSource.edit(),e.$apply()}),e.addRecord=function(t){let i=Katrid.Data.createRecord({},e.dataSource);for(let[e,a]of Object.entries(t))i[e]=a;e.records.push(i)},e.cancelChanges=(()=>e.dataSource.setState(Katrid.Data.DataSourceState.browsing)),e.openItem=(async(t,a)=>{await this.showDialog(e,i,a),e.parent.dataSource.changing&&!e.dataSource.readonly&&e.dataSource.edit(),e.$apply()}),e.editItem=((t,i)=>{e.$parent.dataSource.changing&&(e.dataSource.recordIndex=i,e.dataSource.edit(),setTimeout(()=>{let e=$(t.target).closest("td").find("input.form-control").focus();setTimeout(()=>e.select())},100))}),e.removeItem=function(t){const i=e.records[t];e.records.splice(t,1),e._incChanges(),i.$record.$delete()},e.$set=((t,i)=>{const a=e.form[t];a.$setViewValue(i),a.$render()}),e.save=function(){if(!e.inline){if(e.recordIndex>-1){let t=e.record;e.record=null,e.records.splice(e.recordIndex,1),setTimeout(()=>{e.records.splice(e.recordIndex,0,t),e.$apply()})}else-1===e.recordIndex&&e.records.push(e.record);e.inline||e.gridDialog.modal("toggle"),e._incChanges()}},e.pasteData=async function(){let t={},i=async function(i,a){return new Promise(async(s,r)=>{if(t[i.name]||(t[i.name]={}),void 0===t[i.name][a]){let s=await e.model.getFieldChoices(i.name,a,{exact:!0});s.items&&s.items.length?t[i.name][a]=s.items[0]:t[i.name][a]=null}s(t[i.name][a])})},a=[];for(let t of $(e.view.content).find("field")){let i=e.view.fields[$(t).attr("name")];i&&(_.isUndefined(i.visible)||i.visible)&&a.push(i)}let s=await navigator.clipboard.readText();for(let t of s.split(/\r?\n/))if(t){let s=0,r={};for(let e of t.split(/\t/)){let t=a[s];t instanceof Katrid.Data.Fields.ForeignKey?r[t.name]=await i(t,o(e)):r[t.name]=o(e),s++}e.addRecord(r)}e.$apply()};let l=e.$on("masterChanged",async function(t,i,s){if(i===e.dataSource.masterSource&&(e.dataSet=[],e._changeCount=0,e.records=[],null!=s)){const t={};if(t[a.field]=s,s)return await e.dataSource.search(t).finally(()=>e.dataSource.state=Katrid.Data.DataSourceState.browsing)}});e.$on("$destroy",function(){l(),s.masterSource.children.splice(s.masterSource.indexOf(s),1)})}async renderDialog(e,t){let i,a=e.views.form.content;e.view=e.views.form;let s=e.views.form.fields[e.field.field];return s&&(s.visible=!1),t.inline?(i=me.$compile(a)(e),gridEl.find(".inline-input-dialog").append(i)):(a=$(Katrid.app.$templateCache.get("view.field.OneToManyField.Dialog").replace("\x3c!-- view content --\x3e",'<form-view form-dialog="dialog">'+a+"</form-view>")),(i=this.$compile(a)(e)).find("form").first().addClass("row")),e.formElement=i.find("form").first(),e.form=e.formElement.controller("form"),e.gridDialog=i,t.inline||(i.modal("show"),i.on("hidden.bs.modal",function(){e.record=null,e.dataSource.state=Katrid.Data.DataSourceState.browsing,i.remove(),e.gridDialog=null,e.recordIndex=-1,_destroyChildren()})),i.find(".modal-dialog").addClass("ng-form"),new Promise(function(e){i.on("shown.bs.modal",()=>e(i))})}}]).directive("list",["$compile",e=>({restrict:"E",compile(t,i){let a=i.ngRowClick,s=t.html(),r={};i.listOptions&&(r=JSON.parse(i.listOptions));let n=Katrid.app.getTemplate("view.list.table.pug",{attrs:i,rowClick:a,options:r});return function(t,i,a,o){let l,d=$(n),c=d.find("tbody>tr").first(),p=d.find("thead>tr").first(),h=d.find("tfoot>tr").first();a.inlineEditor&&(d.addClass("inline-editor"),l=$(t.views.form.content),c.attr("ng-class","{'group-header': record._hasGroup, 'form-data-changing': (dataSource.changing && dataSource.recordIndex === $index), 'form-data-readonly': !(dataSource.changing && dataSource.recordIndex === $index)}").attr("ng-form","grid-row-form-{{$index}}").attr("id","grid-row-form-{{$index}}"));let u=$("<div>").append(s),m=[],g=!1;for(let e of u.children("field")){let i=(e=$(e)).attr("name"),s=t.view.fields[i];s.assign(e);let r=e.attr("total");if(r?(g=!0,m.push({field:s,name:i,total:r})):m.push(!1),!s.visible)continue;let n=!1;l&&(n=l.find(`field[name="${i}"]`),n=$(n[0].outerHTML).attr("form-field","form-field").attr("inline-editor",a.inlineEditor)[0].outerHTML);let o=$(Katrid.app.getTemplate(s.template.list,{name:i,field:s,inplaceEditor:n})).first(),d=$(o).next();c.append(d),p.append(o)}if(g)for(total of m)h.append(Katrid.app.getTemplate("view.list.table.total.pug",{field:total.field}));else h.remove();if(r.deleteRow){let e=$(Katrid.app.getTemplate("view.list.table.delete.pug"));c.append(e[1]),p.append(e[0]),g&&h.append('<td class="list-column-delete" ng-show="parent.dataSource.changing && !dataSource.readonly"></td>')}i.html(""),i.append(e(d)(t))}}})])}(),Katrid.ui.uiKatrid.filter("numberFormat",()=>(e,t=3)=>null==e?"":new Intl.NumberFormat("pt-br",{maximumSignificantDigits:t}).format(e)),function(){let e={"=":Katrid.i18n.gettext("Is equal"),"!=":Katrid.i18n.gettext("Is different"),">":Katrid.i18n.gettext("Greater-than"),"<":Katrid.i18n.gettext("Less-than")},t={"=":"","!=":"__isnot",like:"__icontains","not like":"__not_icontains",">":"__gt",">=":"__gte","<":"__lt","<=":"__lte",in:"__in","not in":"__not_in"};class i{constructor(e){this.searchView=e,this.items=[],this.groups=[]}add(e){this.items.includes(e)?(e.facet.addValue(e),e.facet.refresh()):(this.items.push(e),this.searchView.renderFacets()),e instanceof r&&this.groups.push(e),this.searchView.change()}loadItem(e){this.items.push(e),e instanceof r&&this.groups.push(e)}remove(e){this.items.splice(this.items.indexOf(e),1),e instanceof r&&this.groups.splice(this.groups.indexOf(e),1),this.searchView.change()}getParams(){let e=[];for(let t of this.items)e=e.concat(t.getParamValues());return e}}class a{constructor(e){this.item=e,this.values=[],this.teste="teste"}init(e,t){this.item=e,this.values=t||[{searchString:this.item.getDisplayValue(),value:this.item.value}]}addValue(e){return this.values.push(e)}get caption(){return this.item.caption}clear(){this.values=[]}get templateValue(){const e=` <span class="facet-values-separator">${Katrid.i18n.gettext("or")}</span> `;return Array.from(this.values).map(e=>e instanceof d?e.display:e).join(e)}link(e){const t=$(this.template());return this.item.facet=this,this.element=t,t.find(".facet-remove").click(t=>e.onRemoveItem(t,this.item)),t}refresh(){return this.element.find(".facet-value").html(this.templateValue())}load(e){e.query.loadItem(this.item),this.render(e)}destroy(){this.clear()}getParamValues(){const e=[];for(let t of this.values)e.push(this.item.getParamValue(t));return e.length>1?[{OR:e}]:e}}class s{constructor(e,t,i,a,s){this.name=e,this.item=t,this.parent=i,this.ref=a,this.menu=s,this.label=this.item.attr("label")||this.ref&&this.ref.caption||this.name}templateLabel(){return sprintf(Katrid.i18n.gettext("Search <i>%(caption)s</i> by: <strong>%(text)s</strong>"),{caption:this.label,text:"{{search.text}}"})}template(){let e="";return this.expandable&&(e='<a class="expandable" href="#"></a>'),this.value?e=`<a class="search-menu-item indent" href="#">${this.value[1]}</a>`:e+=`<a href="#" class="search-menu-item">${this.templateLabel()}</a>`,`<li>${e}</li>`}link(e,t,i){const a=t(this.template())(e);return null!=i?(a.insertAfter(i.element),i.children.push(this),this.parentItem=i):a.appendTo(this.parent),this.element=a,this.itemEl=a.find(".search-menu-item").click(e=>e.preventDefault()).mousedown(e=>this.select(e)).mouseover(function(e){const t=a.parent().find(">li.active");if(t!==a)return t.removeClass("active"),a.addClass("active")}),this.element.data("searchItem",this),this.expand=a.find(".expandable").on("mousedown",e=>(this.expanded=!this.expanded,e.stopPropagation(),e.preventDefault(),$(e.target).toggleClass("expandable expanded"),this.expanded?this.searchView.menu.expand(this):this.searchView.menu.collapse(this))).click(e=>e.preventDefault()),!1}select(e){return e&&(e.stopPropagation(),e.preventDefault()),this.menu.select(e,this),this.menu.close()}getFacetLabel(){return this.label}getDisplayValue(){return this.value?this.value[1]:this.searchString}getValue(){return this.facet.values.map(e=>e.value||e.searchString)}getParamValue(e,t){const i={};return $.isArray(t)?i[e]=t[0]:i[e+"__icontains"]=t,i}getParamValues(){const e=[];for(let t of Array.from(this.getValue()))e.push(this.getParamValue(this.name,t));return e.length>1?[{OR:e}]:e}destroy(){return this.element.remove()}remove(){this.searchView.removeItem(this)}reset(){return this.expanded=!1,this.expand.removeClass("expanded"),this.expand.addClass("expandable")}onSelect(){}onRemove(){this.facet.element.remove(),delete this.facet}}class r extends s{constructor(e,t,i,a,s){super(e,t,i,a,s);const r=t.attr("context");this.context="string"==typeof r?JSON.parse(r):{grouping:[e]}}getFacetLabel(){return'<span class="fa fa-bars"></span>'}templateLabel(){return Katrid.i18n.gettext("Group by:")+" "+this.label}getDisplayValue(){return this.label}}class n{constructor(e,t,i){this.view=e,this.name=t,this.el=i}getDisplayValue(){return this.value?this.value[1]:this.searchString}getParamValue(e,t){const i={};return _.isArray(t)?i[e]=t[0]:i[e+"__icontains"]=t,i}_doChange(){this.view.update()}}class o extends n{constructor(e,t,i,a,s,r){super(e,t,r),this.group=s,this.label=i,_.isString(a)&&(a=JSON.parse(a.replace(/'/g,'"'))),this.domain=a,this._selected=!1}static fromItem(e,t,i){return new o(e,t.attr("name"),t.attr("label"),t.attr("domain"),i,t)}toString(){return this.label}toggle(){this.selected=!this.selected}get selected(){return this._selected}set selected(e){this._selected=e,e?this.group.addValue(this):this.group.removeValue(this),this._doChange()}getDisplayValue(){return this.label}get facet(){return this.group.facet}getParamValue(){return this.domain}get value(){return this.domain}}class l extends Array{constructor(e){super(),this.view=e,this._selection=[],this._facet=new a(this)}static fromItem(e,t){let i=new l(e);return i.push(o.fromItem(e,t,i)),i}static fromGroup(e,t){let i=new l(e);for(let a of t.children())i.push(o.fromItem(e,$(a),i));return i}addValue(e){this._selection.push(e),console.log(e.value),this._facet.values=this._selection.map(e=>new d(e.toString(),e.value)),this._refresh()}removeValue(e){this._selection.splice(this._selection.indexOf(e),1),this._facet.values=this._selection.map(e=>({searchString:e.getDisplayValue(),value:e.value})),this._refresh()}selectAll(){for(let e of this)this.addValue(e);this.view.update()}get caption(){return'<span class="fa fa-filter"></span>'}_refresh(){this._selection.length?-1===this.view.facets.indexOf(this._facet)&&this.view.facets.push(this._facet):this.view.facets.indexOf(this._facet)>-1&&this.view.facets.splice(this.view.facets.indexOf(this._facet),1),console.log(this.view.facets)}getParamValue(e){return e.value}clear(){this._selection=[]}}class d{constructor(e,t){this.display=e,this.value=t}}class c extends n{constructor(e,t,i,a){super(e,t,i),this.field=a,this._expanded=!1,"ForeignKey"===a.type?(this.expandable=!0,this.children=[]):this.expandable=!1}get expanded(){return this._expanded}set expanded(e){this._expanded=e,e?this._loadChildren():this.children=[]}_loadChildren(){this.loading=!0,this.view.scope.model.getFieldChoices(this.name,this.view.text).then(e=>this.children=e.items).finally(()=>this.view.scope.$apply(()=>this.loading=!1))}get facet(){return this._facet||(this._facet=new a(this)),this._facet}getDisplayValue(){return this.value}getParamValue(e){const t={};let i=this.name;if(_.isArray(e))t[i]=e[0];else{if(e instanceof d)return e.value;t[i+"__icontains"]=e}return t}get caption(){return this.field.caption}get value(){return this._value?this._value[1]:this.view.text}select(){this.facet.addValue(this.value),this.view.addFacet(this.facet),this.view.close(),this.view.update()}selectItem(e){let t={};t[this.field.name]=e[0],this.facet.addValue(new d(e[1],t)),this.view.addFacet(this.facet),this.view.close(),this.view.update()}static fromField(e,t){let i=e.view.fields[t.attr("name")];return new c(e,i.name,t,i)}get template(){return _.sprintf(Katrid.i18n.gettext("Search <i>%(caption)s</i> by: <strong>%(text)s</strong>"),{caption:this.field.caption,text:this.view.text})}}Katrid.ui.uiKatrid.controller("CustomFilterController",["$scope","$element","$filter",function(i,a,s){i.tempFilter=null,i.customFilter=[],i.fieldChange=function(e){i.field=e,i.condition=e.defaultCondition,i.conditionChange(i.condition)},i.conditionChange=(e=>{i.controlVisible=i.field.isControlVisible(e)}),i.valueChange=(e=>{i.searchValue=e}),i.addCondition=((a,s,r)=>{i.tempFilter||(i.tempFilter=new l(i.$parent.search)),i.tempFilter.push(new class extends o{constructor(e,t,i,a,s){super(e,t.name,t.caption,null,s),this.field=t,this.condition=i,this._value=a,this._selected=!0}toString(){let t=this.field.format(this._value);return this.field.caption+" "+e[this.condition].toLowerCase()+' "'+t+'"'}get value(){let e={};return e[this.field.name+t[this.condition]]=this._value,e}}(i.$parent.search,a,s,r,i.tempFilter)),i.field=null,i.condition=null,i.controlVisible=!1,i.searchValue=void 0}),i.applyFilter=(()=>{i.searchValue&&i.addCondition(i.field,i.condition,i.searchValue),i.customFilter.push(i.tempFilter),i.tempFilter.selectAll(),i.tempFilter=null,i.customSearchExpanded=!1})}]).directive("customFilter",()=>({restrict:"A",scope:{action:"="}}));class p{constructor(e,t,a){this.scope=e,this.element=t,this.query=new i(this),this.viewMoreButtons=!1,this.items=[],this.fields=[],this.filterGroups=[],this.groups=[],this.facets=[],this.input=t.find(".search-view-input"),this.view=a,this.el=$(a.content),this.menu=t.find(".search-dropdown-menu.search-view-menu");for(let e of this.el.children()){let t,i=(e=$(e)).prop("tagName");if("FILTER"===i)t=l.fromItem(this,e),this.filterGroups.push(t);else if("FILTER-GROUP"===i)t=l.fromGroup(this,e),this.filterGroups.push(t);else if("FIELD"===i){t=c.fromField(this,e),this.fields.push(t);continue}this.append(t)}this.input.on("input",e=>this.input.val().length?this.show(e):this.close(e)).on("keydown",e=>{switch(e.which){case Katrid.ui.Keyboard.keyCode.DOWN:this.move(1),e.preventDefault();break;case Katrid.ui.Keyboard.keyCode.UP:this.move(-1),e.preventDefault();break;case Katrid.ui.Keyboard.keyCode.ENTER:this.scope.$apply(()=>angular.element(this.menu.find("a.search-menu-item.active")).scope().item.select(e));break;case $.ui.keyCode.BACKSPACE:""===this.input.val()&&(this.scope.$apply(()=>this.facets.splice(this.facets.length-1,1).map(e=>e.clear())),this.update())}}).on("blur",e=>(this.input.val(""),this.close()))}append(e){this.items.push(e)}addFacet(e){this.facets.includes(e)||this.facets.push(e)}first(){this.menu.find("a.search-menu-item.active").removeClass("active"),this.menu.find("a.search-menu-item").first().addClass("active")}remove(e){this.facets[e].destroy(),this.facets.splice(e,1),this.update()}getParams(){let e=[];for(let t of this.facets)e=e.concat(t.getParamValues());return e}move(e){const t=e>0;for(e=Math.abs(e);0!==e;){e--;let i=this.element.find(".search-view-menu > li.active");i.length?(i.removeClass("active"),(i=t?i.next():i.prev()).addClass("active")):(i=t?this.element.find(".search-view-menu > li").first():this.element.find(".search-view-menu > li").last()).addClass("active")}}update(){this.scope.action.setSearchParams(this.getParams())}show(){this.menu.show(),this.first()}close(){this.menu.hide(),this.reset(),this.input.val("")}reset(){for(let e of this.fields)e&&e.children&&e.children.length&&(e.expanded=!1)}}class h{constructor(){this.retrict="E",this.templateUrl="view.search",this.replace=!0,this.scope=!1}}Katrid.ui.uiKatrid.controller("SearchMenuController",["$scope",function(e){}]),Katrid.ui.uiKatrid.directive("searchView",h),Katrid.ui.uiKatrid.directive("searchViewArea",class{constructor(){this.restrict="A",this.scope=!1}link(e,t,i){let a=e.action.views.search;e.search=new p(e,t,a)}}),Katrid.ui.Views.SearchView=p,Katrid.ui.Views.SearchViewComponent=h,Katrid.ui.Views.SearchMenu=class{show(){return this.element.show(),this.searchView.first()}close(){this.element.hide(),this.reset()}async expand(e){let t=await this.searchView.scope.model.getFieldChoices(e.ref.name,this.searchView.scope.search.text);return console.log(t),t.items.map(t=>this.searchView.loadItem(e.item,t,e))}collapse(e){for(let t of Array.from(e.children))t.destroy();return e.children=[]}reset(){for(let e of this.searchView.items)e.children&&(this.collapse(e),e.reset())}select(e,t){if(this.options.select)return t.parentItem&&(t.parentItem.value=t.value,t=t.parentItem),t.searchString=this.input.val(),this.options.select(e,t),this.input.val("")}}}(),function(){let e=Katrid.ui.uiKatrid,t=0;e.directive("formField",["$compile",function(e){return{restrict:"A",priority:99,replace:!0,compile:(t,i)=>(function(i,a,s,r){let n=i.view.fields[s.name];if(_.isUndefined(n))throw Error('Invalid field name "'+s.name+'"');let o=n.template.form;if(n.assign(a),!n.visible)return void t.remove();let l=n.getAttributes(s),d={};l["ng-readonly"]&&(d["ng-readonly"]=l["ng-readonly"].toString()),s.ngShow&&(d["ng-show"]=s.ngShow);let c=a.html();o=Katrid.app.getTemplate(o,{name:s.name,field:n,attrs:l,content:c,fieldAttributes:s,sectionAttrs:d}),o=e(o)(i),a.replaceWith(o);let p=o.find(".form-field");if(p.length){p=p[p.length-1];const e=o.controller("form");(r=angular.element(p).data().$ngModelController)&&e.$addControl(r)}})}}]),e.directive("inputField",()=>({restrict:"A",scope:!1,link(e,t,i){$(t).on("click",function(){$(this).select()})}})),e.directive("view",()=>({restrict:"E",template:(e,i)=>(t++,""),link(e,i,a){if(e.model)return i.attr("class",`view-form-${e.model.name.replace(new RegExp(".","g"),"-")}`),i.attr("id",`katrid-form-${t.toString()}`),i.attr("model",e.model),i.attr("name",`dataForm${t.toString()}`)}})),e.directive("ngSum",()=>({restrict:"A",priority:9999,require:"ngModel",link(e,t,i,a){const s=i.ngSum.split("."),r=s[0],n=s[1];return e.$watch(`record.$${r}`,function(t,i){if(t&&e.record){let t=0;e.record[r].map(e=>t+=parseFloat(e[n])),t.toString()!==a.$modelValue&&(a.$setViewValue(t),a.$render())}})}})),e.directive("ngEnter",()=>(e,t,i)=>t.bind("keydown keypress",t=>{13===t.which&&(e.$apply(()=>e.$eval(i.ngEnter,{$event:t})),t.preventDefault())})),e.directive("ngEsc",()=>(e,t,i)=>t.bind("keydown keypress",t=>{27===t.which&&(e.$apply(()=>e.$eval(i.ngEsc,{$event:t})),t.preventDefault())})),e.directive("datetimepicker",["$filter",e=>({restrict:"A",require:"?ngModel",link(t,i,a,s){$(i).datetimepicker({});const r=Katrid.i18n.gettext("yyyy-MM-dd hh:mma");!0===Katrid.Settings.UI.dateInputMask?(console.log("set input mask"),i=i.mask(r.replace(/[A-z]/g,0))):Katrid.settings.UI.dateInputMask&&(i=i.mask(Katrid.Settings.UI.dateInputMask)),i.on("click",()=>setTimeout(()=>$(i).select())),s.$formatters.push(function(t){if(t){new Date(t);return e("date")(t,r)}return t}),s.$render=function(){if(_.isDate(s.$viewValue)){const t=e("date")(s.$viewValue,r);return i.val(t)}return i.val(s.$viewValue)}}})]),e.directive("ajaxChoices",["$location",e=>({restrict:"A",require:"?ngModel",link(e,t,i,a){const{multiple:s}=i,r={ajax:{type:"POST",url:i.ajaxChoices,dataType:"json",quietMillis:500,params:{contentType:"application/json; charset=utf-8"},data:(e,t)=>JSON.stringify({q:e,count:1,page:t-1,field:i.field,model:i.modelChoices}),results(e,t){let i=e.items;const a=t*Katrid.settings.services.choicesPageLimit<e.count;return{results:Array.from(i).map(e=>({id:e[0],text:e[1]})),more:a}}},escapeMarkup:e=>e,initSelection(e,t){const i=a.$modelValue;if(i){if(s){const e=[];for(let t of Array.from(i))e.push({id:t[0],text:t[1]});return t(e)}return t({id:i[0],text:i[1]})}}};s&&(r.multiple=!0);const n=t.select2(r);t.on("$destroy",function(){return $(".select2-hidden-accessible").remove(),$(".select2-drop").remove(),$(".select2-drop-mask").remove()}),n.on("change",function(t){const i=n.select2("data");return a.$setDirty(),i&&(a.$viewValue=i),e.$apply()}),a.$render=(()=>{if(a.$viewValue)return t.select2("val",a.$viewValue)})}})]),e.directive("uiMask",()=>({restrict:"A",link(e,t,i){t.mask(i.uiMask)}}));e.directive("decimal",["$filter",class{constructor(e){this.restrict="A",this.require="ngModel",this.$filter=e}link(e,t,i,a){let s=e.view.fields[i.name].decimalPlaces;i.decimalPlaces&&(s=parseInt(i.decimalPlaces));const r=i.uiMoneyThousands||".",n=i.uiMoneyDecimal||",";i.uiMoneySymbol,i.uiMoneyNegative,$(t).number(!0,s,n,r)}}]),e.filter("moment",()=>(function(e,t){return t?moment().format(t):moment(e).fromNow()})),e.directive("fileReader",()=>({restrict:"A",require:"ngModel",scope:{},link:(e,t,i,a)=>("image/*"===i.accept&&t.tag,t.bind("change",function(){const e=new FileReader;return e.onload=(e=>a.$setViewValue(e.target.result)),e.readAsDataURL(event.target.files[0])}))})),e.directive("dateInput",["$filter",e=>({restrict:"A",require:"?ngModel",link(e,t,i,a){let s=()=>{let e;e="date"===i.type?(new Date).toISOString().split("T")[0]:moment(new Date).format("YYYY-MM-DD HH:mm").replace(" ","T"),$(t).val(e),a.$setViewValue(e),r=!1},r=!0;t.focus(function(){""===$(this).val()&&(r=!0)}).keypress(function(e){"h"===e.key.toLowerCase()&&(s(),e.stopPropagation(),e.preventDefault())}).keydown(function(e){/\d/.test(e.key)&&""===$(this).val()&&r&&s()}),a.$formatters.push(function(e){if(e)return"date"===i.type?new Date(moment.utc(e).format("YYYY-MM-DD")+"T00:00"):new Date(e)}),a.$parsers.push(function(e){if(console.log("parser",e,a),_.isDate(e))return"date"===i.type?moment.utc(e).format("YYYY-MM-DD"):moment.utc(e).format("YYYY-MM-DDTHH:mm:ss")})}})]),e.directive("cardDraggable",()=>({restrict:"A",link(e,t,i,a){let s={connectWith:i.cardDraggable,items:"> .sortable-item"};_.isUndefined(i.cardItem)||(s.receive=((e,t)=>{let i=angular.element(t.item.parent()).scope(),a=angular.element(t.item).scope();console.log(a),console.log(i);let s={};s.id=a.record.id,$.extend(s,i.group._domain),i.model.write([s]).then(e=>{console.log("write ok",e)})})),_.isUndefined(i.cardGroup)||(s.update=((i,a)=>{let s=[];$.each(a.item.parent().find(".card-group"),(e,t)=>{s.push($(t).data("id"))});let r=t.find(".card-group").first().data("group-name"),n=e.$parent.$parent.view.fields[r].model;Katrid.Services.data.reorder(n,s).done(e=>{console.log(e)})})),t.sortable(s).disableSelection()}})),e.directive("uiTooltip",()=>({restrict:"A",link:(e,t,i)=>{$(t).tooltip({container:"body",delay:{show:200,hide:500}})}})),e.setFocus=(e=>{let t=$(e);t.data("select2")?t.select2("focus"):e.focus()}),e.directive("attachmentsButton",()=>({restrict:"A",scope:!1,link:(e,t)=>{let i;e.$parent.$watch("recordId",t=>{let a=new Katrid.Services.Model("ir.attachment",e);e.$parent.attachments=[],clearTimeout(i),i=setTimeout(()=>{a.search({params:{model:e.action.model.name,object_id:t},count:!1}).then(t=>{let i=null;t&&t.data&&(i=t.data),e.$apply(()=>e.attachments=i)})},1e3)})}})),e.directive("action",["$compile",e=>({restrict:"E",priority:99,link:(e,t,i)=>{console.log("define action",i.ngClick);let a=t.closest("div.data-form").find(".dropdown-menu-actions"),s=(i.name,`<li><a href="javascript:void(0)">${t.html()}</a></li>`),r=$(s);r.click(()=>{i.object&&e.model.rpc(i.object,[e.$parent.record.id])}),a.append(r),t.remove()}})])}(),function(){let e=0,t={BooleanField:3,DecimalField:3,FloatField:3,DateField:3,DateTimeField:3,IntegerField:3,SmallIntegerField:3,TimeField:3,CharField:3,OneToManyField:12};class i{static get tag(){return"input"}constructor(e,i,a,s){if(this.attrs=i,this.scope=e,this.templAttrs={},this.wAttrs={},this.field=a,this.element=s,this.content=s.html(),this.spanPrefix="",null!=a.depends&&a.depends.length&&e.dataSource.addFieldWatcher(a),i.ngShow&&(this.templAttrs["ng-show"]=i.ngShow),(i.ngReadonly||a.readonly)&&(this.templAttrs["ng-readonly"]=i.ngReadonly||a.readonly),a.attrs)for(let e of a.attrs){let t=a.attrs[e];(e.startsWith("container")||"ng-show"===e&&!i.ngShow)&&(this.templAttrs[e]=t)}i.ngFieldChange&&(this.wAttrs["ng-change"]=i.ngFieldChange);let r=i.cols;r||("CharField"===a.type&&a.max_length&&a.max_length<30&&(r=3),r||(r=t[a.type]||6)),this.col=r,this.classes=["form-field"],a.onchange&&e.$watch()}fieldChangeEvent(){}get caption(){return this.element.attr("label")||this.field.caption}renderTo(e,t=!1,i=""){let a=[];for(let[e,t]of Object.entries(this.templAttrs))a.push(e+'="'+t+'"');return t?`<${e} class="${i}" ${a.join("")}>${this.template(this.scope,this.element,this.attrs,this.field)}</${e}>`:`<${e} class="${this.field.type} section-field-${this.field.name} form-group" ${a.join("")}>`+this.template(this.scope,this.element,this.attrs,this.field)+`</${e}>`}get ngModel(){return`record.${this.field.name}`}get id(){return this._id||(this._id=++e),`katrid-input-${this._id.toString()}`}widgetAttrs(){let e;const t=this.wAttrs;if(this.field.required&&(t.required=null),t["ng-model"]=this.ngModel,this.field.attrs)for(let i of Object.keys(this.field.attrs))e=this.field.attrs[i],i.startsWith("container-")||"ng-show"===i||"ng-readonly"===i||(t[i]=e);if(!_.isUndefined(this.attrs.$attr))for(let i of Object.keys(this.attrs.$attr)){let a=this.attrs.$attr[i];a.startsWith("container-")||"ngShow"===i||"ngReadonly"===i||(e=this.attrs[i],a.startsWith("field-")?a=a.substr(6,a.length-6):"class"===a&&this.classes.push(e),t[a]=e)}return(null!=this.attrs.readonly||this.field.readonly)&&(t.readonly=""),this.classes&&(t.class=this.classes.join(" ")),t}_getWidgetAttrs(e,t,i,a){let s="";const r=this.widgetAttrs(e,t,i,a);for(let e in r){const t=r[e];s+=` ${e}`,(t||!1===t)&&(_.isString(t)&&t.indexOf('"')>-1?s+=`='${t}'`:s+=`="${t}"`)}return this.placeholder&&(s+=` placeholder="${this.placeholder}" `),s}innerHtml(){return""}labelTemplate(){const e=this.caption;return"placeholder"===this.attrs.nolabel?(this.placeholder=e,""):_.isUndefined(this.attrs.nolabel)?`<label for="${this.id}" class="form-label">${e}</label>`:""}get emptyText(){return this.inplaceEditor?"":"--"}get readOnlyClass(){return this.inplaceEditor||"::"===this.spanPrefix?"grid-field-readonly":"form-field-readonly"}spanTemplate(e,t,i,a){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}record.${this.field.name}.toString() || '${this.emptyText}' }}</span>`}widgetTemplate(){let e=`<${this.constructor.tag} id="${this.id}" name="${this.field.name}" ${this._getWidgetAttrs()}>`;const t=this.innerHtml();return t&&(e+=t+`</${this.constructor.tag}>`),e}template(){let e="",t=this.spanTemplate();this.inplaceEditor||(e=this.labelTemplate());let i=this.widgetTemplate();return"inline"===this.inline&&(i=`<div ng-if="dataSource.changing && dataSource.recordIndex === $index">${i}</div>`),`<div>${e}${t}${i}</div>`}link(e,t,i,a,s){if(s.depends)return(()=>{const t=[];for(let i of Array.from(s.depends))Array.from(e.dataSource.fieldChangeWatchers).includes(i)||(e.dataSource.fieldChangeWatchers.push(i),t.push(e.$watch(`record.${i}`,function(t,a){if(t!==a&&e.dataSource.changing)return e.model.onFieldChange(i,e.record).done(e.dataSource.onFieldChange)})));return t})()}th(){let e=`${this.field.type} list-column`,t=this.element.attr("label")||`{{view.fields.${this.field.name}.caption}}`;return`<th class="${e}" name="${this.field.name}"><span>${t}</span></th>`}_gridEditor(e){return this.renderTo("section",!0,e)}_tdContent(){return this.spanTemplate()}_td(e){let t;return this.inplaceEditor?t=this._gridEditor(e):(this.spanPrefix="::",t=this.spanTemplate()),`<td class="${e}">${t}</td>`}td(){return this.content?this.content:this._td(`${this.field.type} field-${this.field.name}`)}}class a extends i{static get tag(){return"input input-field"}constructor(){super(...arguments),this.classes.push("form-control")}get type(){return"text"}widgetTemplate1(){let e;e=this.constructor.tag.startsWith("input")?`<${this.tag} id="${attrs._id}" type="${type}" name="${attrs.name}" ${this._getWidgetAttrs(scope,el,attrs,field)}>`:`<${this.tag} id="${attrs._id}" name="${attrs.name}" ${this._getWidgetAttrs(scope,el,attrs,field)}>`;const t=this.innerHtml(scope,el,attrs,field);return t&&(e+=t+`</${this.tag}>`),e}widgetTemplate(){this.type;const e=this.attrs.icon;let t=`<${this.constructor.tag} id="${this.id}" type="${this.type}" name="${this.field.name}" ${this._getWidgetAttrs()}>`;if(e)return`<label class="prepend-icon"><i class="icon ${e}"></i>${t}</label>`;const i=this.innerHtml();return i&&(t+=i+`</${this.constructor.tag}>`),t}}class s extends a{widgetAttrs(){const e=super.widgetAttrs();return this.field.maxLength&&(e.maxlength=this.field.maxLength.toString()),e}}class r extends a{static get tag(){return"input decimal"}get type(){return Katrid.settings.ui.isMobile?"number":"text"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|number) || '${this.emptyText}' }}</span>`}}class n extends r{static get tag(){return'input decimal decimal-places="0"'}}class o extends a{static get tag(){return"select"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}view.fields.${this.field.name}.displayChoices[record.${this.field.name}] || '${this.emptyText}' }}</span>`}innerHtml(){return`<option ng-repeat="choice in view.fields.${this.field.name}.choices" value="{{choice[0]}}">{{choice[1]}}</option>`}}class l extends s{static get tag(){return"textarea"}}class d extends r{static get tag(){return Katrid.settings.ui.isMobile?"input":"input decimal"}get type(){return Katrid.settings.ui.isMobile?"number":"text"}spanTemplate(){let e=this.attrs.decimalPlaces||2;return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|number:${e}) || '${this.emptyText}' }}</span>`}_tdContent(){let e,t=this.element.attr("decimal-places");return t?e`number:${t}`:e=`numberFormat:${this.element.attr("max-digits")||6}`,`{{::record.${this.field.name}|${e} }}`}}class c extends d{spanTemplate(){let e=this.attrs.maxDigits,t="number";return e?t="numberFormat":e=this.attrs.decimalPlaces||2,`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|${t}:${e}) || '${this.emptyText}' }}</span>`}_tdContent(e){let t=this.element.attr("max-digits");return t?`<td class="${e}">{{::record.${this.field.name}|numberFormat:${t} }}${this._gridEditor()}</td>`:(t=2,`{{::record.${this.field.name}|number:${t} }}`)}}class p extends a{spanTemplate(){return`<span class="${this.readOnlyClass} bool-text">\n  {{${this.spanPrefix}record.${this.field.name} ? '${Katrid.i18n.gettext("yes")}' : '${Katrid.i18n.gettext("no")}'}}\n  </span>`}get type(){return"checkbox"}_td(e){return super._td("bool-text "+e)}widgetTemplate(){let e=super.widgetTemplate();return e=`<label class="checkbox" ng-show="dataSource.changing">${e}`,this.field.help_text?e+=this.field.help_text:e+=this.field.caption,e+="<i></i></label>"}labelTemplate(){return this.field.help_text?super.labelTemplate():`<label for="${this.id}" class="form-label form-label-checkbox"><span>${this.caption}</span>&nbsp;</label>`}}class h extends a{static get tag(){return"input file-reader"}get type(){return"file"}}class u extends h{static get tag(){return'input file-reader accept="image/*"'}spanTemplate(){return""}widgetTemplate(){let e=super.widgetTemplate(),t=this.attrs.ngEmptyImage||this.attrs.emptyImage&&"'"+this.attrs.emptyImage+"'"||"'/static/web/assets/img/no-image.png'";return e=`<div class="image-box image-field">\n  <img ng-src="{{ record.${this.field.name} || ${t} }}" />\n    <div class="text-right image-box-buttons">\n    <button class="btn btn-default" type="button" title="${Katrid.i18n.gettext("Change")}" onclick="$(this).closest('.image-box').find('input').trigger('click')"><i class="fa fa-pencil"></i></button>\n    <button class="btn btn-default" type="button" title="${Katrid.i18n.gettext("Clear")}" ng-click="$set('${this.field.name}', null)"><i class="fa fa-trash"></i></button>\n    </div>\n      ${e}</div>`}}class m extends a{get type(){return"password"}spanTemplate(){return'<span class="form-field-readonly">*******************</span>'}}class g extends i{constructor(...e){super(...e),this.col=null}static get tag(){return"sortable-field"}get type(){return"hidden"}_td(e){return`<td onclick="event.preventDefault();event.stopPropagation();" class="list-column-sortable">${this.spanTemplate()}</td>`}th(){return`<th class="list-column-sortable" name="${this.field.name}"></th>`}spanTemplate(){return`<sortable-field id="${this.id}" name="${this.field.name}" ng-model="record.${this.field.name}"/>`}}Object.assign(this.Katrid.ui.Widgets,{Field:i,InputWidget:a,StringField:s,IntegerField:n,SelectionField:o,ForeignKey:class extends i{static get tag(){return"input foreignkey"}spanTemplate(){let e=!0;return(null!=this.attrs.allowOpen&&"false"===this.attrs.allowOpen||null==this.attrs.allowOpen&&this.field.attrs&&!1===this.field.attrs["allow-open"])&&(e=!1),!e||this.inList?`<span class="${this.readOnlyClass}"><a href="javascript:void(0)">{{ ${this.spanPrefix}record.${this.field.name}[1] || '${this.emptyText}' }}</a></span>`:`<span class="${this.readOnlyClass}"><a href="#/action/${this.field.model}/view/?id={{ ${this.spanPrefix}record.${this.field.name}[0] }}" ng-click="action.openObject('${this.field.model}', record.${this.field.name}[0], $event, '${this.field.caption}')">{{ ${this.spanPrefix}record.${this.field.name}[1] }}</a><span ng-if="!record.${this.field.name}[1]">--</span></span>`}get type(){return"hidden"}_tdContent(){return`{{record.${this.field.name}[1]}}`}},TextField:l,DecimalField:c,FloatField:d,DateField:class extends l{static get tag(){return"input date-input"}get type(){return"date"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|date:'${Katrid.i18n.gettext("yyyy-mm-dd").replace(/[m]/g,"M")}') || '${this.emptyText}' }}</span>`}_tdContent(e){return`{{::record.${this.field.name}|date:'${Katrid.i18n.gettext("yyyy-MM-dd")}'}}`}},DateTimeField:class extends l{static get tag(){return"input date-input"}get type(){return"datetime-local"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|date:'${Katrid.i18n.gettext("yyyy-MM-dd hh:mma")}') || '${this.emptyText}' }}</span>`}},TimeField:class extends a{get type(){return"time"}},BooleanField:p,OneToManyField:class extends i{static get tag(){return"grid"}spanTemplate(){return""}innerHtml(){return this.content}},ManyToManyField:class extends i{static get tag(){return"input foreignkey multiple"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}record.${this.field.name}|m2m }}</span>`}get type(){return"hidden"}},FileField:h,PasswordField:m,ImageField:u,SortableField:g,input:a,string:s,integer:n,selection:o,text:l,decimal:c,float:d,file:h,boolean:p,password:m,image:u,sortable:g})}(),function(){let e=Katrid.ui.uiKatrid;e.controller("TabsetController",["$scope",function(e){const t=this,i=t.tabs=e.tabs=[];t.select=function(e){angular.forEach(i,function(t){t.active&&t!==e&&(t.active=!1,t.onDeselect())}),e.active=!0,e.onSelect()},t.addTab=function(e){i.push(e),1===i.length?e.active=!0:e.active&&t.select(e)},t.removeTab=function(e){const s=i.indexOf(e);if(e.active&&i.length>1&&!a){const e=s===i.length-1?s-1:s+1;t.select(i[e])}i.splice(s,1)};var a=void 0;e.$on("$destroy",function(){a=!0})}]),e.directive("tabset",()=>({restrict:"EA",transclude:!0,replace:!0,scope:{type:"@"},controller:"TabsetController",template:'<div class="tabset"><div class="clearfix"></div>\n  <div class="nav nav-{{type || \'tabs\'}}" ng-class="{\'nav-stacked\': vertical, \'nav-justified\': justified}" ng-transclude></div>\n  <div class="tab-content">\n    <div class="tab-pane" \n         ng-repeat="tab in tabs" \n         ng-class="{active: tab.active}"><div class="col-12"><div class="row" tab-content-transclude="tab"></div></div>    </div>\n  </div>\n</div>\n',link:(e,t,i)=>(e.vertical=!!angular.isDefined(i.vertical)&&e.$parent.$eval(i.vertical),e.justified=!!angular.isDefined(i.justified)&&e.$parent.$eval(i.justified))})),e.directive("tab",["$parse",e=>({require:"^tabset",restrict:"EA",replace:!0,template:'<a class="nav-item nav-link" href ng-click="select()" tab-heading-transclude ng-class="{active: active, disabled: disabled}">{{heading}}</a>',transclude:!0,scope:{active:"=?",heading:"@",onSelect:"&select",onDeselect:"&deselect"},controller(){},compile:(t,i,a)=>(function(t,i,s,r){t.$watch("active",function(e){e&&r.select(t)}),t.disabled=!1,s.disabled&&t.$parent.$watch(e(s.disabled),function(e){t.disabled=!!e}),t.select=function(){t.disabled||(t.active=!0)},r.addTab(t),t.$on("$destroy",function(){r.removeTab(t)}),t.$transcludeFn=a})})]),e.directive("tabHeadingTransclude",[()=>({restrict:"A",require:"^tab",link(e,t,i,a){e.$watch("headingElement",function(e){e&&(t.html(""),t.append(e))})}})]),e.directive("tabContentTransclude",function(){return{restrict:"A",require:"^tabset",link(e,t,i){const a=e.$eval(i.tabContentTransclude);a.$transcludeFn(a.$parent,function(e){angular.forEach(e,function(e){(e=>e.tagName&&(e.hasAttribute("tab-heading")||e.hasAttribute("data-tab-heading")||"tab-heading"===e.tagName.toLowerCase()||"data-tab-heading"===e.tagName.toLowerCase()))(e)?a.headingElement=e:t.append(e)})})}}})}.call(this),function(){Katrid.ui.uiKatrid.directive("comments",()=>({restrict:"E",scope:{},replace:!0,template:'<div class="content"><div class="comments"><mail-comments/></div></div>',link(e,t,i){t.closest(".modal-dialog").length?t.remove():$(t).closest(".form-view[ng-form=form]").find(".content-scroll>.content").append(t)}})),Katrid.ui.uiKatrid.directive("mailComments",()=>({restrict:"E",controller:["$scope",e=>{e.comments=new class{constructor(e){this.scope=e,this.model=this.scope.$parent.model,this.scope.$parent.$watch("recordId",e=>{this.items=null,this.scope.loading=Katrid.i18n.gettext("Loading..."),clearTimeout(this._pendingOperation),this._pendingOperation=setTimeout(()=>(this._pendingOperation=null,this.masterChanged(e),this.scope.$apply(()=>this.scope.loading=null)),1e3)}),this.items=[]}async masterChanged(e){if(e){const e=new Katrid.Services.Model("mail.message");if(this.scope.$parent.record)return e.post("get_messages",{args:[this.scope.$parent.record.messages]}).then(e=>{this.items=e,this.scope.$apply()})}}async _sendMesage(e,t){t&&(t=t.map(e=>e.id));let i=await this.model.post("post_message",{args:[[this.scope.$parent.recordId]],kwargs:{content:e,content_subtype:"html",format:!0,attachments:t}});this.scope.message="",this.items=i.concat(this.items),this.scope.$apply(),this.scope.files=null,this.scope.hideEditor()}postMessage(e){if(this.scope.files.length){let i=[];for(let e of this.scope.files)i.push(e.file);var t=this;Katrid.Services.Attachments.upload({files:i},this.scope).done(i=>{t._sendMesage(e,i)})}else this._sendMesage(e)}}(e),e.files=[],e.showEditor=(()=>{$(e.el).find("#mail-editor").show(),$(e.el).find("#mail-msgEditor").focus()}),e.hideEditor=(()=>{$(e.el).find("#mail-editor").hide()}),e.attachFile=(t=>{for(let i of t.files)e.files.push({name:i.name,type:i.type,file:i});e.$apply()}),e.deleteFile=(t=>{e.files.splice(t,1)})}],replace:!0,link(e,t,i){e.el=t},template:()=>`\n  <div class="container">\n          <h3>${Katrid.i18n.gettext("Comments")}</h3>\n          <div class="form-group">\n          <button class="btn btn-outline-secondary" ng-click="showEditor();">${Katrid.i18n.gettext("New message")}</button>\n          <button class="btn btn-outline-secondary">${Katrid.i18n.gettext("Log an internal note")}</button>\n          </div>\n          <div id="mail-editor" style="display: none;">\n            <div class="form-group">\n              <textarea id="mail-msgEditor" class="form-control" ng-model="message"></textarea>\n            </div>\n            <div class="form-group">\n              <button class="btn btn-default" type="button" onclick="$(this).next().click()"><i class="fa fa-paperclip"></i></button>\n              <input class="input-file-hidden" type="file" multiple onchange="angular.element(this).scope().attachFile(this)">\n            </div>\n            <div class="form-group" ng-show="files.length">\n              <ul class="list-inline attachments-area">\n                <li ng-repeat="file in files" ng-click="deleteFile($index)" title="${Katrid.i18n.gettext("Delete this attachment")}">{{ file.name }}</li>\n              </ul>\n            </div>\n            <div class="from-group">\n              <button class="btn btn-primary" ng-click="comments.postMessage(message)">${Katrid.i18n.gettext("Send")}</button>\n            </div>\n          </div>\n  \n          <hr>\n  \n          <div ng-show="loading">{{ loading }}</div>\n          <div class="comment media col-sm-12" ng-repeat="comment in comments.items">\n            <div class="media-left">\n              <img src="/static/web/assets/img/avatar.png" class="avatar rounded">\n            </div>\n            <div class="media-body">\n              <strong>{{ ::comment.author[1] }}</strong> - <span class="timestamp text-muted" title="{{ ::comment.date_time|moment:'LLLL'}}"> {{::comment.date_time|moment}}</span>\n              <div class="clearfix"></div>\n              <div class="form-group">\n                {{::comment.content}}\n              </div>\n              <div class="form-group" ng-if="comment.attachments">\n                <ul class="list-inline">\n                  <li ng-repeat="file in comment.attachments"><a href="/web/content/{{ ::file.id }}/?download">{{ ::file.name }}</a></li>\n                </ul>\n              </div>\n            </div>\n          </div>\n    </div>`}));class e extends Katrid.ui.Widgets.Widget{static initClass(){this.prototype.tag="mail-comments"}spanTemplate(e,t,i,a){return""}}e.initClass(),Katrid.ui.Widgets.MailComments=e}(),function(){class e{getSettingsDropdown(e){if("form"===e)return`<ul class="dropdown-menu pull-right">\n    <li>\n      <a href="javascript:void(0);" ng-click="action.showDefaultValueDialog()">${Katrid.i18n.gettext("Set Default")}</a>\n    </li>\n  </ul>`}getSetDefaultValueDialog(){}static get cssListClass(){return"table table-striped table-bordered table-condensed table-hover display responsive nowrap dataTable no-footer dtr-column"}renderList(e,t,i,a,s,r=!0){let n='<th ng-show="dataSource.groups.length"></th>',o=!1,l=[],d='<td ng-show="dataSource.groups.length" class="group-header">\n  <div ng-show="record._group">\n  <span class="fa fa-fw fa-caret-right"\n    ng-class="{\'fa-caret-down\': record._group.expanded, \'fa-caret-right\': record._group.collapsed}"></span>\n    {{::record._group.__str__}} ({{::record._group.count }})</div></td>';r&&(n+="<th class=\"list-record-selector\"><input type=\"checkbox\" ng-click=\"action.selectToggle($event.currentTarget)\" onclick=\"$(this).closest('table').find('td.list-record-selector input').prop('checked', $(this).prop('checked'))\"></th>",d+='<td class="list-record-selector" onclick="event.stopPropagation();"><input title="teste" type="checkbox" ng-click="action.selectToggle($event.currentTarget)" onclick="if (!$(this).prop(\'checked\')) $(this).closest(\'table\').find(\'th.list-record-selector input\').prop(\'checked\', false)"></td>');for(let i of Array.from(t.children())){let t=i.outerHTML,a=(i=$(i)).attr("name");if(!a){d+=`<td>${i.html()}</td>`,n+="<th><span>${col.attr('label')}</span></th>";continue}let s=i.attr("total");s?(l.push([a,s]),o=!0):l.push(s),a=i.attr("name");const r=e.view.fields[a];if("False"===i.attr("visible")||!1===r.visible)continue;let c=r.createWidget(i.attr("widget"),e,i,i);c.inList=!0,c.inplaceEditor=Boolean(e.inline),n+=c.th(i.attr("label")),d+=c.td(e.inline,t,i)}s&&(n+='<th class="list-column-delete" ng-show="parent.dataSource.changing && !dataSource.readonly">',d+='<td class="list-column-delete" ng-show="parent.dataSource.changing && !dataSource.readonly" ng-click="removeItem($index);$event.stopPropagation();"><i class="fa fa-trash-o"></i></td>'),null==a&&(a="action.listRowClick($index, row, $event)"),o=o?`<tfoot><tr>${l.map(e=>e?`<td class="text-right"><strong><ng-total field="${e[0]}" type="${e[1]}"></ng-total></ strong></td>`:'<td class="borderless"></td>').join("")}</tr></tfoot>`:"";let c=" grid";return e.inline&&(c+=" inline-editor"),`<table class="${this.constructor.cssListClass}${c}">\n  <thead><tr>${n}</tr></thead>\n  <tbody>\n  <tr ng-repeat="record in records | limitTo:totalDisplayed" ng-click="${a}" ng-class="{'group-header': record._hasGroup, 'form-data-changing': (dataSource.changing && dataSource.recordIndex === $index), 'form-data-readonly': !(dataSource.changing && dataSource.recordIndex === $index)}" ng-form="grid-row-form-{{$index}}" id="grid-row-form-{{$index}}">${d}</tr>\n  </tbody>\n  ${o}\n  </table>\n  <a href="javascript:void(0)" ng-show="records.length > totalDisplayed" ng-click="totalDisplayed = totalDisplayed + 1000">${Katrid.i18n.gettext("View more...")}</a>\n  `}renderGrid(e,t,i,a){const s=this.renderList(e,t,i,a,!0,!1);let r;return`<div style="overflow-x: auto;"><div ng-show="!dataSource.readonly">\n  ${r="inline"==i.inline?`\n<button class="btn btn-xs btn-info" ng-click="addItem()" ng-show="parent.dataSource.changing && !dataSource.changing" type="button">${Katrid.i18n.gettext("Add")}</button>\n<button class="btn btn-xs btn-info" ng-click="addItem()" ng-show="dataSource.changing" type="button">${Katrid.i18n.gettext("Save")}</button>\n<button class="btn btn-xs btn-info" ng-click="cancelChanges()" ng-show="dataSource.changing" type="button">${Katrid.i18n.gettext("Cancel")}</button>\n`:`\n<button class="btn btn-xs btn-info" ng-click="addItem()" ng-show="parent.dataSource.changing" type="button">${Katrid.i18n.gettext("Add")}</button>\n<button class="btn btn-xs btn-outline-secondary float-right" ng-click="pasteData()" ng-show="parent.dataSource.changing" type="button" title="${Katrid.i18n.gettext("Paste")}">\n<i class="fa fa-clipboard"></i>\n</button>\n`}\n  </div><div class="row inline-input-dialog" ng-show="dataSource.changing"/>${s}</div>`}windowDialog(e){console.log("window dialog",e)}renderReportDialog(e){return`<div ng-controller="ReportController">\n  <form id="report-form" method="get" action="/web/reports/report/">\n    <div class="data-heading panel panel-default">\n      <div class="panel-body">\n      <h2>{{ report.name }}</h3>\n      <div class="toolbar">\n        <button class="btn btn-primary" type="button" ng-click="report.preview()"><span class="fa fa-print fa-fw"></span> ${Katrid.i18n.gettext("Preview")}</button>\n  \n        <div class="btn-group">\n          <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"\n                  aria-expanded="false">${Katrid.i18n.gettext("Export")} <span class="caret"></span></button>\n          <ul class="dropdown-menu">\n            <li><a ng-click="Katrid.Reports.Reports.preview()">PDF</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('docx')">Word</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('xlsx')">Excel</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('pptx')">PowerPoint</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('csv')">CSV</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('txt')">${Katrid.i18n.gettext("Text File")}</a></li>\n          </ul>\n        </div>\n  \n        <div class="btn-group">\n          <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"\n                  aria-expanded="false">${Katrid.i18n.gettext("My reports")} <span class="caret"></span></button>\n          <ul class="dropdown-menu">\n            <li><a ng-click="Katrid.Reports.Reports.preview()">PDF</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('docx')">Word</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('xlsx')">Excel</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('pptx')">PowerPoint</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('csv')">CSV</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('txt')">${Katrid.i18n.gettext("Text File")}</a></li>\n          </ul>\n        </div>\n  \n      <div class="pull-right btn-group">\n        <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"\n                aria-expanded="false"><i class="fa fa-gear fa-fw"></i></button>\n        <ul class="dropdown-menu">\n          <li><a href="javascript:void(0)" ng-click="report.saveDialog()">${Katrid.i18n.gettext("Save")}</a></li>\n          <li><a href="#">${Katrid.i18n.gettext("Load")}</a></li>\n        </ul>\n      </div>\n  \n      </div>\n    </div>\n    </div>\n    <div class="col-sm-12">\n      <table class="col-sm-12" style="margin-top: 20px; display:none;">\n        <tr>\n          <td colspan="2" style="padding-top: 8px;">\n            <label>${Katrid.i18n.gettext("My reports")}</label>\n  \n            <select class="form-control" ng-change="action.userReportChanged(action.userReport.id)" ng-model="action.userReport.id">\n                <option value=""></option>\n                <option ng-repeat="rep in userReports" value="{{ rep.id }}">{{ rep.name }}</option>\n            </select>\n          </td>\n        </tr>\n      </table>\n    </div>\n  <div id="report-params">\n  <div id="params-fields" class="col-sm-12 form-group">\n    <div class="checkbox"><label><input type="checkbox" ng-model="paramsAdvancedOptions"> ${Katrid.i18n.gettext("Advanced options")}</label></div>\n    <div ng-show="paramsAdvancedOptions">\n      <div class="form-group">\n        <label>${Katrid.i18n.gettext("Printable Fields")}</label>\n        <input type="hidden" id="report-id-fields"/>\n      </div>\n      <div class="form-group">\n        <label>${Katrid.i18n.gettext("Totalizing Fields")}</label>\n        <input type="hidden" id="report-id-totals"/>\n      </div>\n    </div>\n  </div>\n  \n  <div id="params-sorting" class="col-sm-12 form-group">\n    <label class="control-label">${Katrid.i18n.gettext("Sorting")}</label>\n    <select multiple id="report-id-sorting"></select>\n  </div>\n  \n  <div id="params-grouping" class="col-sm-12 form-group">\n    <label class="control-label">${Katrid.i18n.gettext("Grouping")}</label>\n    <select multiple id="report-id-grouping"></select>\n  </div>\n  \n  <div class="clearfix"></div>\n  \n  </div>\n    <hr>\n      <table class="col-sm-12">\n        <tr>\n          <td class="col-sm-4">\n            <select class="form-control" ng-model="newParam">\n              <option value="">--- ${Katrid.i18n.gettext("FILTERS")} ---</option>\n              <option ng-repeat="field in report.fields" value="{{ field.name }}">{{ field.label }}</option>\n            </select>\n          </td>\n          <td class="col-sm-8">\n            <button\n                class="btn btn-default" type="button"\n                ng-click="report.addParam(newParam)">\n              <i class="fa fa-plus fa-fw"></i> ${Katrid.i18n.gettext("Add Parameter")}\n            </button>\n          </td>\n        </tr>\n      </table>\n  <div class="clearfix"></div>\n  <hr>\n  <div id="params-params">\n    <div ng-repeat="param in report.params" ng-controller="ReportParamController" class="row form-group">\n      <div class="col-sm-12">\n      <div class="col-sm-4">\n        <label class="control-label">{{param.label}}</label>\n        <select ng-model="param.operation" class="form-control" ng-change="param.setOperation(param.operation)">\n          <option ng-repeat="op in param.operations" value="{{op.id}}">{{op.text}}</option>\n        </select>\n      </div>\n      <div class="col-sm-8" id="param-widget"></div>\n      </div>\n    </div>\n  </div>\n  </form>\n  </div>  `}}Katrid.ui.utils={BaseTemplate:e,Templates:new e}}(),function(){Katrid.ui.uiKatrid.directive("numpadInput",["$compile",class{constructor(e){this.restrict="A",this.require="ngModel",this.scope={},this.$compile=e}link(e,t,i,a){t.bind("click",()=>{console.log("numpad click");let t=this.$compile(Katrid.app.getTemplate("ui.numpad.pug"))(e);e.val=parseFloat(a.$modelValue||0),e.$apply();let s=$(t).modal();s.on("hidden.bs.modal",function(){$(this).remove()}),e.done=(()=>{e.$parent.record[a.$name]=e.val.toString(),i.ngChange&&e.$parent.$eval(i.ngChange),a.$setDirty(),s.modal("hide")}),e.cancel=(()=>{s.modal("hide")}),e.buttonClick=(t=>{let i=e.val.toFixed(2).toString().replace(".","");"bs"===t?(i=i.substr(0,i.length-1),e.val=i?parseFloat(i)/100:0):"0"===t?e.val*=10:e.val=parseFloat(i+t)/100})})}}])}(),Katrid.ui.uiKatrid.constant("uiAceConfig",{}).directive("codeEditor",["uiAceConfig",function(e){if(angular.isUndefined(window.ace))throw new Error("ui-ace need ace to work... (o rly?)");return{restrict:"EA",require:"?ngModel",link:function(t,i,a,s){var r,n,o=e.ace||{},l=angular.extend({},o,t.$eval(a.codeEditorOptions)),d=window.ace.edit(i[0]),c=d.getSession(),p=function(){var e=arguments[0],i=Array.prototype.slice.call(arguments,1);angular.isDefined(e)&&t.$evalAsync(function(){if(!angular.isFunction(e))throw new Error("ui-ace use a function as callback.");e(i)})},h=function(e){return function(i){var a=c.getValue();!s||a===s.$viewValue||t.$$phase||t.$root.$$phase||t.$evalAsync(function(){s.$setViewValue(a)}),p(e,i,d)}},u=function(e){return function(){p(e,d)}};a.$observe("readonly",function(e){d.setReadOnly(!!e||""===e)}),s&&(s.$formatters.push(function(e){if(angular.isUndefined(e)||null===e)return"";if(angular.isObject(e)||angular.isArray(e))throw new Error("ui-ace cannot use an object or an array as a model");return e}),s.$render=function(){c.setValue(s.$viewValue)});var m=function(e,i){e!==i&&((l=angular.extend({},o,t.$eval(a.codeEditorOptions))).callbacks=[l.onLoad],l.onLoad!==o.onLoad&&l.callbacks.unshift(o.onLoad),c.removeListener("change",r),r=h(l.onChange),c.on("change",r),d.removeListener("blur",n),n=u(l.onBlur),d.on("blur",n),function(e,t,i){var a,s;if(angular.isDefined(i.workerPath)&&window.ace.require("ace/config").set("workerPath",i.workerPath),angular.isDefined(i.require)&&i.require.forEach(function(e){window.ace.require(e)}),angular.isDefined(i.showGutter)&&e.renderer.setShowGutter(i.showGutter),angular.isDefined(i.useWrapMode)&&t.setUseWrapMode(i.useWrapMode),angular.isDefined(i.showInvisibles)&&e.renderer.setShowInvisibles(i.showInvisibles),angular.isDefined(i.showIndentGuides)&&e.renderer.setDisplayIndentGuides(i.showIndentGuides),angular.isDefined(i.useSoftTabs)&&t.setUseSoftTabs(i.useSoftTabs),angular.isDefined(i.showPrintMargin)&&e.setShowPrintMargin(i.showPrintMargin),angular.isDefined(i.disableSearch)&&i.disableSearch&&e.commands.addCommands([{name:"unfind",bindKey:{win:"Ctrl-F",mac:"Command-F"},exec:function(){return!1},readOnly:!0}]),angular.isString(i.theme)&&e.setTheme("ace/theme/"+i.theme),angular.isString(i.mode)&&t.setMode("ace/mode/"+i.mode),angular.isDefined(i.firstLineNumber)&&(angular.isNumber(i.firstLineNumber)?t.setOption("firstLineNumber",i.firstLineNumber):angular.isFunction(i.firstLineNumber)&&t.setOption("firstLineNumber",i.firstLineNumber())),angular.isDefined(i.advanced))for(a in i.advanced)s={name:a,value:i.advanced[a]},e.setOption(s.name,s.value);if(angular.isDefined(i.rendererOptions))for(a in i.rendererOptions)s={name:a,value:i.rendererOptions[a]},e.renderer.setOption(s.name,s.value);angular.forEach(i.callbacks,function(t){angular.isFunction(t)&&t(e)})}(d,c,l))};t.$watch(a.codeEditorOptions,m,!0),m(o),i.on("$destroy",function(){d.session.$stopWorker(),d.destroy()}),t.$watch(function(){return[i[0].offsetWidth,i[0].offsetHeight]},function(){d.resize(),d.renderer.updateFull()},!0)}}}]),function(){class e extends Katrid.ui.Views.BaseView{constructor(e,t,i){super(e),this.$compile=i,this.templateUrl="dialog.base",this.scope.isDialog=!0}render(){return $(sprintf(Katrid.app.getTemplate(this.templateUrl),{content:this.content}))}show(){return this.el||(this.el=$(this.render()),this.root=this.el.find(".modal-dialog-body"),this.el.find("form").first().addClass("row"),this.$compile(this.el)(this.scope)),this.el.modal("show").on("shown.bs.modal",()=>Katrid.ui.uiKatrid.setFocus(this.el.find(".form-field").first())),this.el}}Katrid.ui.Dialogs={Alerts:class{static success(e){return toastr.success(e)}static warn(e){return toastr.warning(e)}static error(e){return toastr.error(e)}},WaitDialog:class{static show(){$("#loading-msg").show()}static hide(){$("#loading-msg").hide()}},Dialog:e,Window:class extends e{constructor(e,t,i){super(e.$new(),t,i),this.scope.parentAction=e.action,this.scope.views={form:t.view},this.scope.title=t&&t.title||Katrid.i18n.gettext("Create: "),this.scope.view=t.view}show(e,t){let i=this.scope.view,a=this.scope;a.views={form:i},a.isDialog=!0,a.dialogTitle=_.sprintf(Katrid.i18n.gettext("Create: %(title)s"),{title:e.caption}),console.log(Katrid.app.$templateCache.get("view.form.dialog.modal").replace("\x3c!-- view content --\x3e",'<form-view form-dialog="dialog">'+i.content+"</form-view>"));let s=$(Katrid.app.$templateCache.get("view.form.dialog.modal").replace("\x3c!-- view content --\x3e",'<form-view form-dialog="dialog">'+i.content+"</form-view>"));return a.root=s.find("form-view"),(s=this.$compile(s)(a)).find("form").first().addClass("row"),s.modal("show").on("shown.bs.modal",()=>Katrid.ui.uiKatrid.setFocus(s.find(".form-field").first())),s}}}}(),Katrid.ui.uiKatrid.directive("foreignkey",["$compile","$controller",(e,t)=>({restrict:"A",require:"ngModel",link(i,a,s,r){let n,o=a,l=!1;const d=i.view.fields[s.name];a.addClass("form-field"),n=s.serviceName?s:i.action?i.action.model.name:s.foreignkey;const c=function(){},p=function(){};let h=null,u={allowClear:!0,query(e){let t=d.domain;t&&_.isString(t)&&(t=i.$eval(t));let a={args:[e.term],kwargs:{count:1,page:e.page,domain:t,name_fields:s.nameFields&&s.nameFields.split(",")||null}};h&&clearTimeout(h),h=setTimeout(()=>{let t;(t=i.model?i.model.getFieldChoices(d.name,e.term,a.kwargs):new Katrid.Services.Model(d.model).searchName(a)).then(t=>{const i=t.items.map(e=>({id:e[0],text:e[1]})),a=e.page*Katrid.settings.services.choicesPageLimit<t.count;if(!g&&!a){let e;const t=o.data("select2").search.val();(s.allowCreate&&"false"!==s.allowCreate||null==s.allowCreate)&&t&&(e=Katrid.i18n.gettext('Create <i>"%s"</i>...'),i.push({id:c,text:e}))}return e.callback({results:i,more:a})})},400)},ajax:{url:`/api/rpc/${n}/get_field_choices/`,contentType:"application/json",dataType:"json",type:"POST"},formatSelection:e=>e.id===c||e.id===p?Katrid.i18n.gettext("Creating..."):e.text,formatResult(e){const t=o.data("select2").search.val();return e.id===c?(e.str=t,`<strong>${sprintf(e.text,t)}</strong>`):e.id===p?(e.str=t,`<strong>${sprintf(e.text,t)}</strong>`):e.text},initSelection(e,t){let i=r.$modelValue;return g?t(i=i.map(e=>({id:e[0],text:e[1]}))):_.isArray(i)?t({id:i[0],text:i[1]}):void 0}},m=s.noCreateEdit;m=_.isUndefined(m)||!Boolean(m);let{multiple:g}=s;return g&&(u.multiple=!0),o=o.select2(u),m&&o.parent().find("div.select2-container>div.select2-drop").append(`<div style="padding: 4px;"><button class="btn btn-outline-secondary btn-sm">${Katrid.i18n.gettext("Create New...")}</button></div>`).find("button").click(()=>(o.select2("close"),new Katrid.Services.Model(d.model).getViewInfo({view_type:"form"}).then(function(a){new Katrid.ui.Dialogs.Window(i,{view:a},e,t).show(d,t)}))),o.on("change",async t=>{let a=t.added;if(a&&a.id===c){let t=new Katrid.Services.Model(d.model);try{let s=await t.createName(a.str),r={};r[d.name]=s,i.dataSource.setValues(r),o.select2("data",{id:s[0],text:s[1]})}catch(a){let s=await t.getViewInfo({view_type:"form"});Katrid.ui.Dialogs.Window(i,{view:s},e).show()}}else if(!a||a.id!==p)return g&&t.val.length?r.$setViewValue(t.val):(r.$setDirty(),a?r.$setViewValue([a.id,a.text]):r.$setViewValue(null))}).on("select2-open",()=>{if(!l){l=!0;let e=a.closest("div.modal");e.length&&e.on("hide.bs.modal",()=>o.select2("destroy"))}}),r.$parsers.push(e=>e?_.isArray(e)?e:_.isObject(e)?[e.id,e.text]:e:null),g||i.$watch(s.ngModel,(e,t)=>o.select2("val",e)),r.$render=function(){if(g&&r.$viewValue){const e=Array.from(r.$viewValue).map(e=>e[0]);o.select2("val",e)}return r.$viewValue?o.select2("val",r.$viewValue[0]):o.select2("val",null)}}})]),Katrid.ui.uiKatrid.filter("m2m",()=>(function(e){if(_.isArray(e))return e.map(e=>e?e[1]:null).join(", ")})),Katrid.ui.uiKatrid.directive("statusField",["$compile",e=>({restrict:"A",priority:1,replace:!0,link(e,t,i,a){const s=e.view.fields[i.name];e.choices=s.choices,i.readonly||(e.itemClick=(()=>console.log("status field item click"))),t.closest("header").prepend(t)},template:(e,t)=>sprintf(Katrid.app.$templateCache.get("view.field.StatusField"),{fieldName:t.name})})]),Katrid.ui.uiKatrid.directive("sortableField",["$compile","$timeout",(e,t)=>({restrict:"E",require:"ngModel",replace:!0,scope:{},link:{post:function(e,t,i){t.closest("tbody").sortable({helper:function(e,t){let i=t.children(),a=t.clone();return a.children().each(function(e){$(this).width(i.eq(e).width())}),a},stop:function(e,t){$("td.list-column-sortable",t.item.parent()).each(function(e){})}}).disableSelection()}},template:(e,t)=>sprintf(Katrid.$templateCache.get("view.field.SortableField"),{fieldName:t.name})})]),function(e){"use strict";function t(e,t){if(this.createTextRange){var i=this.createTextRange();i.collapse(!0),i.moveStart("character",e),i.moveEnd("character",t-e),i.select()}else this.setSelectionRange&&(this.focus(),this.setSelectionRange(e,t))}function i(e){var t=this.value.length;if(e="start"==e.toLowerCase()?"Start":"End",document.selection){var i,a,s,r=document.selection.createRange();return(i=r.duplicate()).expand("textedit"),i.setEndPoint("EndToEnd",r),s=(a=i.text.length-r.text.length)+r.text.length,"Start"==e?a:s}return void 0!==this["selection"+e]&&(t=this["selection"+e]),t}var a={codes:{188:44,110:44,108:44,109:45,190:46,191:47,192:96,220:92,222:39,221:93,219:91,173:45,187:61,186:59,189:45},shifts:{96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"}};e.fn.number=function(s,r,n,o){o=void 0===o?",":o,n=void 0===n?".":n,r=void 0===r?0:r;var l="\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4),d=new RegExp("[^"+l+"0-9]","g"),c=new RegExp(l,"g");return!0===s?this.is("input:text")?this.on({"keydown.format":function(s){var l=e(this),p=l.data("numFormat"),h=s.keyCode?s.keyCode:s.which,u="",m=i.apply(this,["start"]),g=i.apply(this,["end"]),f="",v=!1;if(a.codes.hasOwnProperty(h)&&(h=a.codes[h]),!s.shiftKey&&h>=65&&h<=90?h+=32:!s.shiftKey&&h>=69&&h<=105?h-=48:s.shiftKey&&a.shifts.hasOwnProperty(h)&&(u=a.shifts[h]),""==u&&(u=String.fromCharCode(h)),8!==h&&u!=n&&!u.match(/[0-9]/)){var w=s.keyCode?s.keyCode:s.which;if(46==w||8==w||9==w||27==w||13==w||(65==w||82==w)&&!0===(s.ctrlKey||s.metaKey)||(86==w||67==w)&&!0===(s.ctrlKey||s.metaKey)||w>=35&&w<=39)return;return s.preventDefault(),!1}if(0==m&&g==this.value.length||0==l.val()?8===h?(m=g=1,this.value="",p.init=r>0?-1:0,p.c=r>0?-(r+1):0,t.apply(this,[0,0])):u===n?(m=g=1,this.value="0"+n+new Array(r+1).join("0"),p.init=r>0?1:0,p.c=r>0?-(r+1):0):0===this.value.length&&(p.init=r>0?-1:0,p.c=r>0?-r:0):p.c=g-this.value.length,r>0&&u==n&&m==this.value.length-r-1)p.c++,p.init=Math.max(0,p.init),s.preventDefault(),v=this.value.length+p.c;else if(u==n)p.init=Math.max(0,p.init),s.preventDefault();else if(r>0&&8==h&&m==this.value.length-r)s.preventDefault(),p.c--,v=this.value.length+p.c;else if(r>0&&8==h&&m>this.value.length-r){if(""===this.value)return;"0"!=this.value.slice(m-1,m)&&(f=this.value.slice(0,m-1)+"0"+this.value.slice(m),l.val(f.replace(d,"").replace(c,n))),s.preventDefault(),p.c--,v=this.value.length+p.c}else 8==h&&this.value.slice(m-1,m)==o?(s.preventDefault(),p.c--,v=this.value.length+p.c):r>0&&m==g&&this.value.length>r+1&&m>this.value.length-r-1&&isFinite(+u)&&!s.metaKey&&!s.ctrlKey&&!s.altKey&&1===u.length&&(f=g===this.value.length?this.value.slice(0,m-1):this.value.slice(0,m)+this.value.slice(m+1),this.value=f,v=m);!1===v&&44===h&&u===n&&(v=this.value.indexOf(n)+1),!1!==v&&t.apply(this,[v,v]),l.data("numFormat",p)},"keyup.format":function(a){var s,n=e(this),o=n.data("numFormat"),l=a.keyCode?a.keyCode:a.which,d=i.apply(this,["start"]);""===this.value||(l<48||l>57)&&(l<96||l>105)&&8!==l||(n.val(n.val()),r>0&&(o.init<1?(d=this.value.length-r-(o.init<0?1:0),o.c=d-this.value.length,o.init=1,n.data("numFormat",o)):d>this.value.length-r&&8!=l&&(o.c++,n.data("numFormat",o))),s=this.value.length+o.c,this.value.length-s===o.decimals&&String.fromCharCode(l)!==o.dec_point&&(s-=1,console.log("set pos",o.dec_point,l,String.fromCharCode(l))),t.apply(this,[s,s]))},"paste.format":function(t){var i=e(this),a=t.originalEvent,s=null;return window.clipboardData&&window.clipboardData.getData?s=window.clipboardData.getData("Text"):a.clipboardData&&a.clipboardData.getData&&(s=a.clipboardData.getData("text/plain")),i.val(s),t.preventDefault(),!1}}).each(function(){var t=e(this).data("numFormat",{c:-(r+1),decimals:r,thousands_sep:o,dec_point:n,regex_dec_num:d,regex_dec:c,init:!1});""!==this.value&&t.val(t.val())}):this.each(function(){var t=e(this),i=+t.text().replace(d,"").replace(c,".");t.number(isFinite(i)?+i:0,r,n,o)}):this.text(e.number.apply(window,arguments))};var s=null,r=null;e.isPlainObject(e.valHooks.text)?(e.isFunction(e.valHooks.text.get)&&(s=e.valHooks.text.get),e.isFunction(e.valHooks.text.set)&&(r=e.valHooks.text.set)):e.valHooks.text={},e.valHooks.text.get=function(t){var i,a=e(t).data("numFormat");return a?""===t.value?"":(i=+t.value.replace(a.regex_dec_num,"").replace(a.regex_dec,"."),""+(isFinite(i)?i:0)):e.isFunction(s)?s(t):void 0},e.valHooks.text.set=function(t,i){var a=e(t).data("numFormat");return a?t.value=e.number(i,a.decimals,a.dec_point,a.thousands_sep):e.isFunction(r)?r(t,i):void 0},e.number=function(e,t,i,a){a=void 0===a?",":a,i=void 0===i?".":i,t=isFinite(+t)?Math.abs(t):0;var s="\\u"+("0000"+i.charCodeAt(0).toString(16)).slice(-4),r="\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4);e=(e+"").replace(".",i).replace(new RegExp(r,"g"),"").replace(new RegExp(s,"g"),".").replace(new RegExp("[^0-9+-Ee.]","g"),"");var n=isFinite(+e)?+e:0,o="";return(o=(t?function(e,t){var i=Math.pow(10,t);return""+Math.round(e*i)/i}(n,t):""+Math.round(n)).split("."))[0].length>3&&(o[0]=o[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,a)),(o[1]||"").length<t&&(o[1]=o[1]||"",o[1]+=new Array(t-o[1].length+1).join("0")),o.join(i)}}(jQuery),function(){Katrid.ui.uiKatrid.directive("ngTotal",["$filter",class{constructor(e){this.restrict="E",this.scope=!1,this.replace=!0,this.$filter=e}template(e,t){return"'"===t.expr[0]?`<span>${t.type.substring(1,t.type.length-1)}</span>`:`<span ng-bind="total$${t.field}|number:2"></span>`}link(e,t,i,a){"'"!==i.expr[0]&&e.$watch("records",t=>{let a=0;t.map(e=>a+=parseFloat(e[i.field])),e["total$"+i.field]=a,e.parent["total$"+e.fieldName+"$"+i.field]=a})}}])}(),function(){Katrid.Actions.ClientAction.register("dashboard",class extends Katrid.ui.Views.ClientView{get templateUrl(){return"view.dashboard"}}),Katrid.ui.uiKatrid.directive("dashboard",["$compile",class extends Katrid.ui.Widgets.Component{constructor(e){super(),this.$compile=e,this.restrict="E",this.scope=!1}async link(e,t,i,a){let s=i.dashboardId,r=new Katrid.Services.Model("ir.dashboard.settings"),n=await r.search({dashboard_id:s});if(n.data){let i=n.data[0].content;i=this.$compile(i)(e),t.append(i)}}}]),Katrid.ui.uiKatrid.directive("chart",class extends Katrid.ui.Widgets.Component{constructor(){super(),this.replace=!0,this.template="<div></div>"}async link(e,t,i){let a,s,r=async()=>{a=_.isUndefined(i.url)?await Katrid.Services.Query.read(i.queryId):await $.ajax({url:i.url,type:"get"}),s&&s.destroy(),s=c3.generate({bindto:t[0],data:{type:"donut",columns:a.data}})};r(),i.$observe("url",r)}}),Katrid.ui.uiKatrid.directive("query",class extends Katrid.ui.Widgets.Component{constructor(){super(),this.scope=!1}link(e,t,i){if(!i.name)throw Error("Query name attribute is required!");let a;(a=_.isUndefined(i.url)?Katrid.Services.Query.read(i.id):$.get(i.url)).then(t=>{let a=t.data.map(e=>_.object(t.fields,e));e.$apply(()=>e[i.name]=a)}),t.remove()}})}(),function(){Katrid.Reports.Telegram=class{static async export(e,t){let i=Katrid.app.$templateCache.get("reportbot.dialog.contacts"),a=$(i);$("body").append(a);let s=a.find("#id-reportbot-select-contacts"),r=new Katrid.Services.Model("res.partner"),n=await r.post("get_telegram_contacts");return n&&(n&&n.map(e=>s.append(`<option value="${e[0]}">${e[1]}</option>`)),s.select2()),a.find("#id-btn-ok").click(async()=>{let t=new Katrid.Services.Model("telegram.pending");const i=e.getUserParams();t.post("export_report",{args:[e.info.id],kwargs:{contacts:s.val(),format:"pdf",params:i}}).ok&&console.log("ok")}),a.modal(),!0}}}();
//# sourceMappingURL=katrid.full.min.js.map