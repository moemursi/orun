var Katrid={};!function(){Settings={},Katrid.Core={Application:class{constructor(e){Katrid.app=this,this.title=e.title,this.plugins=["ui.router","ui.katrid"],this.ngApp=angular.module("katridApp",this.plugins).run(["$templateCache",e=>{this.$templateCache=e}]).config(["$stateProvider",e=>{e.state("menuEntry",{url:"/menu/:menuId/",controller:"MenuController",reloadOnSearch:!1}).state("actionView",{url:"/action/:actionId/?view_type&id",reloadOnSearch:!1,controller:"ActionController",resolve:{action:["$stateParams","$state","$location",async(e,t,r)=>{let s=e;Katrid.Actions.actionManager.clear();let a=await Katrid.Services.Actions.load(s.actionId),i=new Katrid.Services.Model(a.model),n=new Katrid.Actions[a.action_type](a,null,r);return n.model=i,t.$current.data={action:n},await n.execute(),n}]},templateProvider:async(e,t)=>t.$current.data.action.template})}]),angular.element(function(){angular.bootstrap(document,["katridApp"])})}async getTemplate(e){return fetch(e).then(async t=>{let r=await t.text();return this.$templateCache.put(e,r),r})}},Settings:Settings}}(),function(){let e;Katrid.socketio&&(e=new class{constructor(){this.requestId=0,this.requests={}}request(){const t=++e.requestId,r=new $.Deferred;return this.requests[t]=r,r.requestId=t,r}},Katrid.socketio.on("connect",()=>console.log("I'm connected!")),Katrid.socketio.on("api",function(t){return _.isString(t)&&(t=JSON.parse(t)),e.requests[t["req-id"]].resolve(t)}));class t{static get url(){return"/api/rpc/"}constructor(e,t){this.name=e}static $fetch(e,t,r){return r&&(e=new URL(e),Object.entries(r).map((t,r)=>e.searchParams.append(t,r))),fetch(e,t)}static $post(e,t,r){return this.$fetch(e,{method:"POST",credentials:"same-origin",body:JSON.stringify(t),headers:{"content-type":"application/json"}},r).then(e=>e.json())}delete(e,t,r){}get(e,t){if("ws"===Katrid.Settings.servicesProtocol)return Katrid.socketio.emit("api",{channel:"rpc",service:this.name,method:e,data:data,args:t});{const r=this.name?this.name+"/":"",s=Katrid.Settings.server+this.constructor.url+r+e+"/";return $.get(s,t)}}post(t,r,s){let a=Katrid.Application.context;if(r||(r={}),a&&(r.context=a),r={jsonrpc:"2.0",method:t,params:r,id:Math.floor(1e3*Math.random()*1e3*1e3)},"io"===Katrid.Settings.servicesProtocol){const a=e.request();return Katrid.socketio.emit("api",{"req-id":a.requestId,"req-method":"POST",service:this.name,method:t,data:r,args:s}),a}{const e=this.name?this.name+"/":"";let a=Katrid.Settings.server+this.constructor.url+e+t+"/";return s&&(a+=`?${$.param(s)}`),new Promise((e,t)=>{$.ajax({method:"POST",url:a,data:JSON.stringify(r),contentType:"application/json; charset=utf-8",dataType:"json"}).then(r=>{r.error?t(r.error):e(r.result)}).fail(e=>t(e))})}}}class r extends t{searchName(e){return _.isString(e)&&(e={args:e}),this.post("search_name",e)}createName(e){let t={name:e};return this.post("create_name",{kwargs:t})}search(e,t){return this.post("search",{kwargs:e},t)}destroy(e){return _.isArray(e)||(e=[e]),this.post("destroy",{kwargs:{ids:e}})}getById(e){return this.post("get",{args:[e]})}getDefaults(){return this.post("get_defaults",{})}copy(e){return this.post("copy",{args:[e]})}static _prepareFields(e){return e&&(e.fields=Katrid.Data.Fields.Field.fromArray(e.fields),e.fieldList=Object.values(e.fields),Object.values(e.views).map(e=>e.fields=Katrid.Data.Fields.Field.fromArray(e.fields)),Object.keys(e.views).map(t=>e.views[t]=new Katrid.Data.View(e.views[t]))),e}getViewInfo(e){return this.post("get_view_info",{kwargs:e}).then(this.constructor._prepareFields)}async loadViews(e){return this.post("load_views",{kwargs:e}).then(this.constructor._prepareFields)}getFieldsInfo(e){return this.post("get_fields_info",{kwargs:e}).then(this.constructor._prepareFields)}getFieldChoices(e,t,r){return this.post("get_field_choices",{args:[e,t],kwargs:r})}doViewAction(e){return this.post("do_view_action",{kwargs:e})}write(e,t){return new Promise((r,s)=>{this.post("write",{kwargs:{data:e}},t).then(e=>{Katrid.Dialogs.Alerts.success(Katrid.i18n.gettext("Record saved successfully.")),r(e)}).catch(e=>{500===e.status&&e.responseText?alert(e.responseText):Katrid.Dialogs.Alerts.error(Katrid.i18n.gettext("Error saving record changes")),s(e)})})}groupBy(e){return this.post("group_by",{kwargs:e})}autoReport(){return this.post("auto_report",{kwargs:{}})}rpc(e,t,r){return this.post(e,{args:t,kwargs:r})}}class s extends r{constructor(){super("ir.query")}static read(e){return(new s).post("read",{args:[e]})}}class a extends t{static get url(){return"/web/data/"}reorder(e,t,r="sequence",s=0){return this.post("reorder",{args:[e,t,r,s]})}}this.Katrid.Services={Data:a,View:class extends r{constructor(){super("ui.view")}fromModel(e){return this.post("from_model",null,{model:e})}},data:new a(""),Attachments:class{static destroy(e){new r("ir.attachment").destroy(e)}static upload(e,t=null){let r=new FormData;null===t&&(t=angular.element(e).scope()),r.append("model",t.model.name),r.append("id",t.recordId);for(let t of e.files)r.append("attachment",t,t.name);return $.ajax({url:"/web/content/upload/",type:"POST",data:r,processData:!1,contentType:!1}).done(e=>{if(console.log("attachments",t.attachments,t),t.attachments||(t.attachments=[]),e)for(let r of e)t.attachments.push(r);t.$apply()})}},Service:t,Model:r,Query:s,Auth:class extends t{static login(e,t){return this.$post("/web/login/",{username:e,password:t})}},Upload:class{static sendFile(e,t){let r=new FormData;r.append("files",t.files[0]);let s=angular.element(t).scope();$.ajax({url:`/web/file/upload/${s.model.name}/${e}/?id=${s.record.id}`,data:r,processData:!1,contentType:!1,type:"POST",success:e=>{console.log("success",e),s.dataSource.refresh(),Katrid.Dialogs.Alerts.success("Operação realizada com sucesso.")}})}},Actions:class extends r{static load(e){return new r("ir.action").post("load",{args:[e]})}}}}(),function(){class e{constructor(e){this._info=e,this.displayChoices=_.object(e.choices),this.template={list:"view.list.field.pug",form:"view.form.field.pug"},this._info.listTemplate&&(this.template.list=this._info.listTemplate),this._info.formTemplate&&(this.template.form=this._info.formTemplate)}static fromInfo(e){return new(Katrid.Data.Fields[e.type]||t)(e)}static fromArray(e){let t={};return Object.keys(e).map(r=>t[r]=this.fromInfo(e[r])),t}fromJSON(e,t){t.record[this.name]=e}get onChange(){return this._info.onchange}get hasChoices(){return this._info.choices&&this._info.choices.length>0}get choices(){return this._info.choices}get name(){return this._info.name}get model(){return this._info.model}get caption(){return this._info.caption}get readonly(){return this._info.readonly}get maxLength(){return this._info.max_length}get type(){return this._info.type}get paramTemplate(){return"view.param.String"}format(e){return e.toString()}toJSON(e){return e}createWidget(e,t,r,s){return e||("status"===this.name?e="StatusField":this.hasChoices&&(e="SelectionField")),new(Katrid.UI.Widgets[e||this.type]||Katrid.UI.Widgets.StringField)(t,r,this,s)}validate(){}get defaultCondition(){return"="}isControlVisible(e){switch(e){case"is null":case"is not null":return!1}return!0}}class t extends e{}class r extends e{toJSON(e){return e}get paramTemplate(){return"view.param.Date"}format(e){return _.isString(e)?moment(e).format(Katrid.i18n.gettext("yyyy-mm-dd").toUpperCase()):""}}class s extends e{toJSON(e){return e&&_.isString(e)?parseFloat(e):e}}class a extends e{toJSON(e){return _.isArray(e)?e[0]:e}get domain(){return this._info.domain}}Katrid.Data.Fields={Field:e,StringField:t,IntegerField:class extends e{toJSON(e){return e&&_.isString(e)?parseInt(e):e}get paramTemplate(){return"view.param.Integer"}},FloatField:class extends s{},DecimalField:class extends s{},DateTimeField:class extends r{get paramTemplate(){return"view.param.DateTime"}},ForeignKey:a,OneToManyField:class extends e{get field(){return this._info.field}fromJSON(e,t){e&&e instanceof Array&&e.map(e=>{"CREATE"===e.action&&t.childByName(this.name).scope.addRecord(e.values)})}},ManyToManyField:class extends a{toJSON(e){return _.isArray(e)?e.map(e=>_.isArray(e)?e[0]:e):(_.isString(e)&&(e=e.split(",")),e)}},DateField:r,BooleanField:class extends e{get paramTemplate(){return"view.param.Boolean"}}}}(),Katrid.ui={},Katrid.ui.uiKatrid=angular.module("ui.katrid",[]),Katrid.ui.uiKatrid.directive("grid",["$compile",function(e){return{restrict:"E",compile(e){e=$(e);let t={};for(let r of e.children())t[r.tagName.toLowerCase()]={content:r,fields:{}};return $(e).replaceWith('<div class="grid"></div>'),function(e,r){$(t.list).find("field").attr("list-field","list-field")}}}}]).directive("list",()=>({restrict:"E",transclude:!0,replace:!0,template:"<table><tr ng-transclude></tr></table>"})).directive("listField",["$compile",e=>({restrict:"A",replace:!0,transclude:!0,template:"<td ng-transclude></td>",compile:(t,r)=>(t.html(),async function(t,r,s){let a=await Katrid.app.getTemplate("../src/templates/view.list.field.td.pug");a=pug.compile(a)({name:s.name}),r.replaceWith(e(a)(t)),r.append(fieldContent)})})]);
//# sourceMappingURL=katrid.full.min.js.map